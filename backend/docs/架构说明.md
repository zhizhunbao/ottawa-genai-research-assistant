# 🏗️ 渥太华生成式AI研究助手 - 架构说明

## 📊 项目架构概览

本项目采用分层架构设计，确保代码的可维护性、可测试性和可扩展性。系统从简单的JSON文件存储开始，可以无缝迁移到复杂的数据库系统。

```
┌─────────────────────────────────────────────────────────────────┐
│                    前端层 (React/Streamlit)                     │
│                      用户界面与交互                              │
└─────────────────────────┬───────────────────────────────────────┘
                          │ HTTP/REST API
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                     API层 (FastAPI)                           │
│                   - HTTP端点管理                               │
│                   - 请求/响应验证                              │
│                   - 身份验证与授权                             │
│                   - 错误处理与响应                             │
└─────────────────────────┬───────────────────────────────────────┘
                          │ 函数调用
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    服务层 (Services)                          │
│                   - 业务逻辑实现                               │
│                   - 数据转换处理                               │
│                   - 流程编排管理                               │
│                   - 错误处理与日志                             │
└─────────────────────────┬───────────────────────────────────────┘
                          │ 数据操作
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                  仓储层 (Repositories)                        │
│                   - 数据访问抽象                               │
│                   - CRUD操作实现                              │
│                   - 查询方法封装                               │
│                   - 模型转换处理                               │
└─────────────────────────┬───────────────────────────────────────┘
                          │ 文件操作
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                 存储层 (monk/ 目录)                           │
│                   - JSON文件存储                              │
│                   - 文档文件管理                               │
│                   - 简单文件系统                               │
│                   - 易于备份迁移                               │
└─────────────────────────────────────────────────────────────────┘
```

## 🗂️ 目录结构详解

```
backend/
├── app/                   # 应用程序核心
│   ├── api/              # API层 - FastAPI路由端点
│   │   ├── __init__.py
│   │   ├── chat.py       # 聊天对话接口
│   │   ├── documents.py  # 文档管理接口
│   │   ├── reports.py    # 报告生成接口
│   │   ├── users.py      # 用户管理接口
│   │   └── settings.py   # 系统设置接口
│   ├── core/             # 核心配置与工具
│   │   ├── __init__.py
│   │   ├── config.py     # 配置管理
│   │   └── security.py   # 安全认证
│   ├── models/           # Pydantic数据模型
│   │   ├── __init__.py
│   │   ├── user.py       # 用户数据模型
│   │   ├── document.py   # 文档数据模型
│   │   ├── report.py     # 报告数据模型
│   │   └── chat.py       # 聊天数据模型
│   ├── repositories/     # 仓储层 - 数据访问
│   │   ├── __init__.py
│   │   ├── base.py       # 基础仓储类
│   │   ├── user_repository.py      # 用户仓储
│   │   ├── document_repository.py  # 文档仓储
│   │   ├── report_repository.py    # 报告仓储
│   │   └── chat_repository.py      # 聊天仓储
│   ├── services/         # 服务层 - 业务逻辑
│   │   ├── __init__.py
│   │   ├── user_service.py         # 用户服务
│   │   ├── document_service.py     # 文档服务
│   │   ├── report_service.py       # 报告服务
│   │   └── chat_service.py         # 聊天服务
│   └── main.py          # FastAPI应用入口
├── monk/                # 数据存储目录
│   ├── users/          # 用户数据
│   │   └── users.json
│   ├── documents/      # 文档数据
│   │   └── documents.json
│   ├── reports/        # 报告数据
│   │   └── reports.json
│   ├── chats/          # 聊天记录
│   │   └── chats.json
│   └── system/         # 系统配置
│       └── settings.json
├── uploads/            # 文件上传目录
├── docs/              # 项目文档
└── tests/             # 测试代码
```

## 🔄 数据流示例

### 用户创建完整流程：

#### 1. **API层处理** (`/api/users.py`)
```python
@router.post("/", response_model=User)
async def create_user(user_data: UserCreate):
    """创建新用户"""
    user_service = UserService()
    return await user_service.create_user(**user_data.dict())
```

#### 2. **服务层业务逻辑** (`UserService`)
```python
async def create_user(self, username: str, email: str, role: str = "user"):
    """用户创建业务逻辑"""
    # 数据验证
    if await self.user_repo.find_by_email(email):
        raise ValueError("邮箱已存在")
    
    # 创建用户模型
    user = User(
        id=str(uuid4()),
        username=username,
        email=email,
        role=role,
        created_at=datetime.now(),
        is_active=True
    )
    
    # 保存用户
    return self.user_repo.create(user)
```

#### 3. **仓储层数据访问** (`UserRepository`)
```python
def create(self, user: User) -> User:
    """将用户保存到JSON文件"""
    data = self._load_data()
    data.append(user.dict())
    self._save_data(data)
    return user

def find_by_email(self, email: str) -> Optional[User]:
    """根据邮箱查找用户"""
    data = self._load_data()
    for item in data:
        if item.get("email") == email:
            return User(**item)
    return None
```

#### 4. **存储层数据** (`monk/users/users.json`)
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "username": "演示用户",
    "email": "demo@ottawa.ca",
    "role": "user",
    "created_at": "2024-01-15T10:30:00Z",
    "is_active": true,
    "last_login": null
  }
]
```

## 🧩 各层职责详解

### 1. API层 (FastAPI路由)
- **主要职责**: HTTP请求处理、数据验证、响应格式化
- **文件位置**: `backend/app/api/*.py`
- **核心特性**:
  - RESTful API端点设计
  - Pydantic请求/响应模型验证
  - HTTP状态码标准化管理
  - 统一的错误处理机制
  - 自动生成API文档 (Swagger/OpenAPI)

### 2. 服务层 (Business Logic)
- **主要职责**: 业务逻辑实现、数据转换、流程编排
- **文件位置**: `backend/app/services/*.py`
- **核心特性**:
  - 复杂业务规则的实现
  - 数据验证与格式转换
  - 多个仓储的协调操作
  - 事务性操作管理
  - 详细的错误处理和日志记录

### 3. 仓储层 (Data Access)
- **主要职责**: 数据访问抽象、CRUD操作封装
- **文件位置**: `backend/app/repositories/*.py`
- **核心特性**:
  - 统一的数据存储接口
  - 标准化的CRUD操作方法
  - Pydantic模型与字典的转换
  - 复杂查询方法的实现
  - 数据存储方式的抽象化

### 4. 存储层 (monk/目录)
- **主要职责**: 数据持久化、文件系统管理
- **文件位置**: `backend/monk/`
- **核心特性**:
  - 人类可读的JSON格式存储
  - 简单直观的文件组织结构
  - 便于版本控制和备份
  - 无需数据库服务依赖
  - 易于调试和数据迁移

## 🔧 服务实现示例

### 用户服务 (UserService)
```python
class UserService:
    def __init__(self):
        self.user_repo = UserRepository()
    
    async def create_user(self, username: str, email: str, role: str = "user"):
        """创建用户业务逻辑"""
        # 验证邮箱唯一性
        if await self.user_repo.find_by_email(email):
            raise ValueError("邮箱已被使用")
        
        # 验证用户名格式
        if not self._validate_username(username):
            raise ValueError("用户名格式不正确")
        
        # 创建用户对象
        user = User(
            id=str(uuid4()),
            username=username,
            email=email,
            role=role,
            created_at=datetime.now()
        )
        
        return self.user_repo.create(user)
```

### 文档服务 (DocumentService)  
```python
class DocumentService:
    def __init__(self):
        self.document_repo = DocumentRepository()
        
    async def process_document(self, file_path: str, user_id: str):
        """文档处理业务逻辑"""
        # 提取文档内容
        content = await self._extract_text(file_path)
        
        # 生成文档摘要
        summary = await self._generate_summary(content)
        
        # 创建文档记录
        document = Document(
            id=str(uuid4()),
            filename=Path(file_path).name,
            content=content,
            summary=summary,
            user_id=user_id,
            uploaded_at=datetime.now()
        )
        
        return self.document_repo.create(document)
```

### 报告服务 (ReportService)
```python
class ReportService:
    def __init__(self):
        self.report_repo = ReportRepository()
        self.document_repo = DocumentRepository()
        
    async def generate_research_report(self, query: str, user_id: str):
        """生成研究报告"""
        # 搜索相关文档
        relevant_docs = await self.document_repo.search_by_content(query)
        
        # AI生成报告内容
        content = await self._generate_report_content(query, relevant_docs)
        
        # 创建报告记录
        report = Report(
            id=str(uuid4()),
            title=f"研究报告: {query}",
            content=content,
            query=query,
            user_id=user_id,
            created_at=datetime.now()
        )
        
        return self.report_repo.create(report)
```

## 🎯 架构优势

### 1. 关注点分离 (Separation of Concerns)
- **API层**: 专注HTTP协议处理
- **服务层**: 专注业务逻辑实现  
- **仓储层**: 专注数据访问抽象
- **存储层**: 专注数据持久化

### 2. 高度可测试性 (High Testability)
- 每层都可以独立进行单元测试
- 可以轻松模拟(Mock)仓储层进行测试
- 业务逻辑与数据存储完全解耦
- 支持集成测试和端到端测试

### 3. 优秀的可维护性 (Excellent Maintainability)
- 清晰明确的代码组织结构
- 易于理解的数据流向
- 模块化的设计便于功能扩展
- 代码复用性高，重复代码少

### 4. 良好的可扩展性 (Good Scalability)
- 可以无缝切换存储后端 (JSON → Database)
- 易于添加缓存层提升性能
- 可以轻松添加新的服务模块
- 支持微服务架构迁移

### 5. 强类型安全 (Strong Type Safety)
- Pydantic模型提供运行时数据验证
- Python类型提示增强代码可读性
- 减少因类型错误导致的运行时问题
- IDE支持更好的代码补全和错误检测

## 🚀 运行演示

要查看完整的架构演示效果，请运行：

```bash
cd backend
python demo_architecture.py
```

此演示将展示完整的数据流：
- **用户服务** → 用户仓储 → `monk/users/users.json`
- **报告服务** → 报告仓储 → `monk/reports/reports.json`  
- **文档服务** → 文档仓储 → `monk/documents/documents.json`
- **聊天服务** → 聊天仓储 → `monk/chats/chats.json`

## 🔄 数据库迁移路径

当项目规模增长需要使用数据库时，迁移过程非常简单：

### 第一步：保持上层不变
- **API层代码** - 无需任何修改
- **服务层代码** - 业务逻辑保持不变
- **模型定义** - Pydantic模型继续使用

### 第二步：更新仓储层
```python
# 从JSON文件操作
class UserRepository:
    def create(self, user: User):
        data = self._load_json()
        data.append(user.dict())
        self._save_json(data)

# 迁移到数据库操作
class UserRepository:
    def create(self, user: User):
        with SessionLocal() as db:
            db_user = UserModel(**user.dict())
            db.add(db_user)
            db.commit()
```

### 第三步：配置更新
- 添加数据库连接配置
- 更新环境变量设置
- 添加数据库迁移脚本

### 第四步：数据迁移
- 编写迁移脚本将JSON数据导入数据库
- 验证数据完整性
- 切换生产环境配置

这种架构设计确保了从简单文件存储到企业级数据库的平滑升级路径。

## 📝 总结

本架构采用经典的分层设计模式，在保持简单性的同时确保了系统的专业性和可扩展性。通过将复杂性分解到不同的层次，每个开发者都可以专注于特定领域的开发，同时整个团队能够高效协作完成复杂的AI研究助手系统。 