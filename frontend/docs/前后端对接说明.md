# 🔗 前后端API对接说明文档

## 📊 当前状态总结

### ❌ **之前的状态：前端没有真正调用后台API**
您的前端应用目前主要在使用**静态Mock数据**，而不是真正访问后台的FastAPI接口。

### ✅ **现在的状态：已配置为混合API模式**
经过刚才的修改，前端现在可以：
1. **优先尝试调用真实的后端API**
2. **API失败时自动降级到Mock数据**
3. **提供无缝的用户体验**

---

## 🏗️ 前后端架构对接

### 1. **后端API架构**
```
FastAPI Server (http://localhost:8000)
├── /api/v1/chat/message     # 聊天接口
├── /api/v1/documents/       # 文档管理
├── /api/v1/reports/         # 报告生成
├── /api/v1/settings/        # 系统设置
└── /health                  # 健康检查
```

### 2. **前端API服务架构**
```
Frontend Services
├── api.ts                   # 真实API调用
├── hybridApi.ts            # 混合API(优先真实+Mock回退)
└── mockApi.ts              # 纯Mock数据
```

### 3. **API调用流程**
```
用户操作 → hybridApi → 尝试realApi → 成功✅/失败❌ → Mock回退
```

---

## 🔧 关键配置修改

### 1. **前端API地址配置**
```typescript
// frontend/src/services/api.ts (已修改)
const API_BASE_URL = process.env.REACT_APP_API_BASE_URL || 'http://localhost:8000/api/v1';
```

### 2. **Chat接口参数对齐**
```typescript
// 修改前端请求格式以匹配后端期望的格式
sendMessage: async (message: string, conversationId?: string) => {
  return apiClient.post('/chat/message', { 
    message,
    language: 'en',
    context: conversationId 
  });
}
```

### 3. **环境变量配置**
```bash
# .env (需要创建)
REACT_APP_API_STRATEGY=hybrid
REACT_APP_API_BASE_URL=http://localhost:8000/api/v1
REACT_APP_FALLBACK_TO_MOCK=true
REACT_APP_API_TIMEOUT=5000
```

---

## ⚡ 启用真实API对接

### 步骤1: 创建环境变量文件
```bash
# 在 frontend/ 目录下创建 .env 文件
cd frontend
echo "REACT_APP_API_STRATEGY=hybrid
REACT_APP_API_BASE_URL=http://localhost:8000/api/v1
REACT_APP_FALLBACK_TO_MOCK=true
REACT_APP_API_TIMEOUT=5000
REACT_APP_ENABLE_DEBUG=true" > .env
```

### 步骤2: 启动后端服务器
```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 步骤3: 启动前端应用
```bash
cd frontend
npm start
```

### 步骤4: 验证API连接
打开浏览器控制台，发送消息时应该看到：
- 🟢 成功：`API call successful` 
- 🟡 回退：`API call failed, using fallback simulation`

---

## 📱 ChatPage的API集成

### 修改前 (纯Mock模式)
```typescript
// 完全使用本地模拟
const handleSendMessage = async () => {
  // ... 添加用户消息
  
  setTimeout(() => {
    const response = simulateAIResponse(inputValue);
    // ... 添加AI响应
  }, 1500);
};
```

### 修改后 (混合API模式)
```typescript
// 优先使用真实API，失败时回退到Mock
const handleSendMessage = async () => {
  // ... 添加用户消息
  
  try {
    // 🔥 真实API调用
    const apiResponse = await hybridApi.sendMessage(currentInput, conversationId);
    // ... 处理真实响应
  } catch (error) {
    // 🔄 自动回退到Mock
    const response = simulateAIResponse(currentInput);
    // ... 处理Mock响应
  }
};
```

---

## 🌐 API接口对应关系

### Chat接口
| 前端方法 | 后端端点 | 功能 |
|---------|---------|------|
| `hybridApi.sendMessage()` | `POST /api/v1/chat/message` | 发送聊天消息 |
| `hybridApi.getConversationHistory()` | `GET /api/v1/chat/history` | 获取聊天历史 |

### 请求/响应格式
```typescript
// 前端请求格式
{
  message: string,
  language: 'en' | 'fr',
  context?: string
}

// 后端响应格式
{
  id: string,
  response: string,
  language: string,
  timestamp: string,
  sources?: string[],
  charts?: any
}
```

---

## 🔍 调试和测试

### 1. **检查API连接状态**
在浏览器控制台运行：
```javascript
// 检查后端健康状态
fetch('http://localhost:8000/health')
  .then(r => r.json())
  .then(console.log);

// 检查混合API状态
hybridApi.healthCheck().then(console.log);
```

### 2. **查看API调用日志**
- 前端：浏览器开发者工具 → Network 标签
- 后端：终端中的uvicorn日志

### 3. **强制使用不同API模式**
```bash
# 仅使用真实API (无回退)
REACT_APP_API_STRATEGY=real

# 仅使用Mock数据
REACT_APP_API_STRATEGY=mock

# 混合模式 (推荐)
REACT_APP_API_STRATEGY=hybrid
```

---

## 🛠️ 下一步优化建议

### 1. **完善其他页面的API集成**
- DocumentUploadPage → `/api/v1/documents/upload`
- ReportPage → `/api/v1/reports/`
- SettingsPage → `/api/v1/settings/`

### 2. **增加错误处理**
```typescript
// 在hybridApi中添加更详细的错误处理
catch (error) {
  if (error.name === 'NetworkError') {
    // 网络错误处理
  } else if (error.status === 500) {
    // 服务器错误处理
  }
  // ... 其他错误类型
}
```

### 3. **添加加载状态指示器**
```typescript
// 显示API调用状态
const [apiStatus, setApiStatus] = useState<'real' | 'mock' | 'loading'>('loading');
```

### 4. **实现请求缓存**
```typescript
// 缓存API响应以提高性能
const responseCache = new Map();
```

---

## 🎯 总结

### ✅ **已完成的改动**
1. **修正了API基础URL** (8000端口 + /api/v1前缀)
2. **ChatPage集成了hybridApi** (真实API + Mock回退)
3. **对齐了请求参数格式** (message + language + context)
4. **保持了Mock数据回退** (确保演示流畅性)

### 🔄 **现在的工作流程**
1. 用户在ChatPage发送消息
2. 前端调用 `hybridApi.sendMessage()`
3. hybridApi尝试调用后端 `/api/v1/chat/message`
4. 成功 → 显示真实AI响应
5. 失败 → 自动降级到Mock响应

### 🚀 **要完全启用真实API**
1. 创建 `.env` 文件并设置环境变量
2. 确保后端服务在8000端口运行
3. 重启前端应用以加载新配置

现在您的前端应用具备了**真正的API调用能力**，同时保持了**演示友好的回退机制**！ 