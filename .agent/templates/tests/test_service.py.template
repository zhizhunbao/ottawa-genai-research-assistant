"""
{{FeatureName}} Service Tests

服务层单元测试。
"""

import pytest
from unittest.mock import AsyncMock, patch

from app.{{feature_name}}.service import {{FeatureName}}Service
from app.{{feature_name}}.schemas import {{FeatureName}}Create


class Test{{FeatureName}}Service:
    """{{FeatureName}}Service 测试"""

    @pytest.fixture
    def service(self, mock_openai_service, mock_search_service):
        """创建服务实例"""
        return {{FeatureName}}Service(
            openai_service=mock_openai_service,
            search_service=mock_search_service,
        )

    @pytest.mark.asyncio
    async def test_create(self, service):
        """测试创建"""
        # Arrange
        data = {{FeatureName}}Create(name="test")

        # Act
        result = await service.create(data)

        # Assert
        assert result is not None
        # TODO: 添加更多断言

    @pytest.mark.asyncio
    async def test_get_by_id(self, service):
        """测试按 ID 获取"""
        # TODO: 实现测试
        pass

    @pytest.mark.asyncio
    async def test_get_by_id_not_found(self, service):
        """测试获取不存在的记录"""
        # TODO: 实现测试
        pass

    @pytest.mark.asyncio
    async def test_list(self, service):
        """测试列表查询"""
        # TODO: 实现测试
        pass

    @pytest.mark.asyncio
    async def test_update(self, service):
        """测试更新"""
        # TODO: 实现测试
        pass

    @pytest.mark.asyncio
    async def test_delete(self, service):
        """测试删除"""
        # TODO: 实现测试
        pass


class Test{{FeatureName}}ServiceWithMocks:
    """带 Mock 的服务测试"""

    @pytest.mark.asyncio
    async def test_external_service_failure(self, mock_openai_service):
        """测试外部服务失败时的处理"""
        # Arrange
        mock_openai_service.chat_completion.side_effect = Exception("API Error")
        service = {{FeatureName}}Service(openai_service=mock_openai_service)

        # Act & Assert
        with pytest.raises(Exception):
            await service.process("test input")

    @pytest.mark.asyncio
    async def test_fallback_behavior(self):
        """测试降级行为"""
        # Arrange
        service = {{FeatureName}}Service()  # 无外部服务

        # Act
        result = await service.process("test input")

        # Assert
        assert "fallback" in result.lower() or result is not None
