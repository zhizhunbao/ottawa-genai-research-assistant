/**
 * Auth Flow E2E Tests - Login, signup, logout, error handling
 *
 * @module tests/e2e/auth-flow
 * @source cypress-realworld-app/cypress/tests/ui/auth.spec.ts (187L)
 * @source cypress-realworld-app/cypress/support/commands.ts login/signup commands (42-86L)
 * @reference https://github.com/cypress-io/cypress-realworld-app
 * @template S5-M1-F1
 *
 * Comprehensive auth E2E tests covering:
 * 1. Unauthenticated redirect → signin page
 * 2. Full signup → onboarding → login → logout flow
 * 3. Login validation errors (empty fields, short password)
 * 4. Signup validation errors (required fields, password mismatch)
 * 5. Invalid credentials handling
 * 6. Remember me / session persistence
 *
 * Key patterns from cypress-realworld-app:
 * - data-test selectors via getBySel() custom command
 * - cy.intercept() for API mocking and waiting
 * - cy.task("db:seed") for test data setup
 * - Mobile-responsive assertions via isMobile()
 * - Visual snapshots at key states
 */

import { test, expect, type Page } from "@playwright/test";

// ─── Test Config ────────────────────────────────────────────────────────────

const TEST_USER = {
  username: "testuser",
  password: "s3cret",
};

const SIGNUP_USER = {
  firstName: "Bob",
  lastName: "Ross",
  username: "PainterJoy90",
  password: "s3cret",
};

// ─── Helpers ────────────────────────────────────────────────────────────────
// @source cypress-realworld-app/cypress/support/commands.ts login command (42-86L)

async function login(page: Page, username: string, password: string) {
  await page.goto("/signin");
  await page.getByTestId("signin-username").fill(username);
  await page.getByTestId("signin-password").fill(password);
  await page.getByTestId("signin-submit").click();
}

async function signup(page: Page, user: typeof SIGNUP_USER) {
  await page.goto("/signup");
  await page.getByTestId("signup-first-name").fill(user.firstName);
  await page.getByTestId("signup-last-name").fill(user.lastName);
  await page.getByTestId("signup-username").fill(user.username);
  await page.getByTestId("signup-password").fill(user.password);
  await page.getByTestId("signup-confirm-password").fill(user.password);
  await page.getByTestId("signup-submit").click();
}

// ─── Auth Flow Tests ────────────────────────────────────────────────────────

test.describe("User Sign-up and Login", () => {
  // @source auth.spec.ts line 7-18 — seed database before each test
  // Replace with your own test data seeding strategy
  test.beforeEach(async ({ page }) => {
    // TODO: Call your API to seed test data
    // await page.request.post('/api/test/seed');
  });

  // @source auth.spec.ts line 20-24
  test("should redirect unauthenticated user to signin page", async ({
    page,
  }) => {
    await page.goto("/dashboard");
    await expect(page).toHaveURL(/\/signin/);
  });

  // @source auth.spec.ts line 26-31
  test("should redirect to the home page after login", async ({ page }) => {
    await login(page, TEST_USER.username, TEST_USER.password);
    await expect(page).toHaveURL("/");
  });

  // @source auth.spec.ts line 50-109 — full signup → login → logout
  test("should allow a visitor to sign-up, login, and logout", async ({
    page,
  }) => {
    // Sign up
    await signup(page, SIGNUP_USER);

    // Wait for redirect to signin
    await expect(page).toHaveURL(/\/signin/);

    // Login
    await login(page, SIGNUP_USER.username, SIGNUP_USER.password);
    await expect(page).toHaveURL("/");

    // Logout
    await page.getByTestId("sidenav-signout").click();
    await expect(page).toHaveURL(/\/signin/);
  });

  // @source auth.spec.ts line 111-129 — login validation errors
  test("should display login errors", async ({ page }) => {
    await page.goto("/signin");

    // Focus and blur username field (trigger required validation)
    const usernameInput = page.getByTestId("signin-username");
    await usernameInput.fill("User");
    await usernameInput.clear();
    await usernameInput.blur();
    await expect(page.locator("#username-helper-text")).toContainText(
      "Username is required"
    );

    // Short password validation
    const passwordInput = page.getByTestId("signin-password");
    await passwordInput.fill("abc");
    await passwordInput.blur();
    await expect(page.locator("#password-helper-text")).toContainText(
      "Password must contain at least 4 characters"
    );

    // Submit should be disabled
    await expect(page.getByTestId("signin-submit")).toBeDisabled();
  });

  // @source auth.spec.ts line 131-165 — signup validation errors
  test("should display signup errors", async ({ page }) => {
    await page.goto("/signup");

    const fields = [
      { testId: "signup-first-name", helperId: "firstName-helper-text", msg: "First Name is required" },
      { testId: "signup-last-name", helperId: "lastName-helper-text", msg: "Last Name is required" },
      { testId: "signup-username", helperId: "username-helper-text", msg: "Username is required" },
    ];

    for (const { testId, helperId, msg } of fields) {
      const input = page.getByTestId(testId);
      await input.fill("value");
      await input.clear();
      await input.blur();
      await expect(page.locator(`#${helperId}`)).toContainText(msg);
    }

    // Password mismatch
    await page.getByTestId("signup-password").fill("password123");
    await page.getByTestId("signup-confirm-password").fill("DIFFERENT");
    await page.getByTestId("signup-confirm-password").blur();
    await expect(page.locator("#confirmPassword-helper-text")).toContainText(
      "Password does not match"
    );

    // Submit should be disabled
    await expect(page.getByTestId("signup-submit")).toBeDisabled();
  });

  // @source auth.spec.ts line 167-174 — invalid credentials
  test("should error for an invalid user", async ({ page }) => {
    await login(page, "invalidUserName", "invalidPa$$word");

    await expect(page.getByTestId("signin-error")).toBeVisible();
    await expect(page.getByTestId("signin-error")).toHaveText(
      "Username or password is invalid"
    );
  });

  // @source auth.spec.ts line 176-185 — wrong password for existing user
  test("should error for wrong password on existing user", async ({
    page,
  }) => {
    await login(page, TEST_USER.username, "WRONG_PASSWORD");

    await expect(page.getByTestId("signin-error")).toBeVisible();
    await expect(page.getByTestId("signin-error")).toHaveText(
      "Username or password is invalid"
    );
  });
});
