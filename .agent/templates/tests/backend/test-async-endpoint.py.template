"""
Async Endpoint Integration Tests - FastAPI TDD patterns

@module tests/backend/test-async-endpoint
@source fastapi-tdd-docker/project/tests/test_summaries.py (238L)
@source fastapi-tdd-docker/project/tests/conftest.py (46L)
@reference https://github.com/testdrivenio/fastapi-tdd-docker
@template S5-M3-F1

Production-grade async endpoint test patterns:
1. CRUD endpoint tests (create, read, read_all, update, delete)
2. Validation error tests (422 responses with detail)
3. Not found tests (404 responses)
4. Parametrized negative scenarios
5. Monkeypatch for external service mocking
6. Test fixtures with dependency override

Key patterns from fastapi-tdd-docker:
- test_app fixture: override get_settings dependency
- test_app_with_db: TestClient + real DB (register_tortoise)
- monkeypatch.setattr for mocking external functions
- @pytest.mark.parametrize for edge cases
- Assert both status_code and response body structure
"""

import json
from typing import Any

import pytest
from httpx import AsyncClient

# ─── conftest.py patterns ────────────────────────────────────────────────────
# @source fastapi-tdd-docker/project/tests/conftest.py (1-46L)
#
# @pytest.fixture(scope="module")
# def test_app():
#     from app.main import create_application
#     from app.config import get_settings, Settings
#     def get_settings_override():
#         return Settings(testing=True, database_url="sqlite:///./test.db")
#     app = create_application()
#     app.dependency_overrides[get_settings] = get_settings_override
#     with TestClient(app) as client:
#         yield client
#
# @pytest.fixture(scope="module")
# def test_app_with_db():
#     # Same as above but with real DB connection
#     ...


# ─── Fixtures ────────────────────────────────────────────────────────────────

@pytest.fixture
def sample_payload() -> dict[str, Any]:
    """Valid payload for creating a resource."""
    return {"url": "https://example.com", "title": "Test Resource"}


@pytest.fixture
def invalid_payloads() -> list[tuple[dict, int, str]]:
    """(payload, expected_status, expected_error_substring) tuples."""
    return [
        ({}, 422, "Field required"),
        ({"url": "invalid://url"}, 422, "URL scheme should be"),
        ({"url": "https://example.com", "title": ""}, 422, "at least 1 character"),
    ]


# ─── Create (POST) ──────────────────────────────────────────────────────────
# @source test_summaries.py line 8-19

def test_create_resource(test_app_with_db, sample_payload, monkeypatch):
    """Test creating a new resource via POST."""
    # Mock any external service calls
    def mock_process(resource_id: int, url: str):
        return None

    # monkeypatch.setattr(module, "process_resource", mock_process)

    response = test_app_with_db.post(
        "/api/v1/resources/",
        content=json.dumps(sample_payload),
    )

    assert response.status_code == 201
    data = response.json()
    assert data["url"] == sample_payload["url"]
    assert "id" in data


# @source test_summaries.py line 22-41
def test_create_resource_invalid_json(test_app):
    """Test validation errors on invalid POST payload."""
    # Missing required field
    response = test_app.post("/api/v1/resources/", content=json.dumps({}))
    assert response.status_code == 422
    assert response.json()["detail"][0]["msg"] == "Field required"

    # Invalid URL scheme
    response = test_app.post(
        "/api/v1/resources/",
        content=json.dumps({"url": "invalid://url"}),
    )
    assert response.status_code == 422


# ─── Read (GET) ─────────────────────────────────────────────────────────────
# @source test_summaries.py line 43-66

def test_read_resource(test_app_with_db, sample_payload, monkeypatch):
    """Test reading a single resource by ID."""
    def mock_process(resource_id, url):
        return None

    # monkeypatch.setattr(module, "process_resource", mock_process)

    # Create first
    response = test_app_with_db.post(
        "/api/v1/resources/",
        content=json.dumps(sample_payload),
    )
    resource_id = response.json()["id"]

    # Read back
    response = test_app_with_db.get(f"/api/v1/resources/{resource_id}/")
    assert response.status_code == 200

    data = response.json()
    assert data["id"] == resource_id
    assert data["url"] == sample_payload["url"]
    assert data["created_at"]


def test_read_resource_incorrect_id(test_app_with_db):
    """Test 404 for non-existent resource."""
    response = test_app_with_db.get("/api/v1/resources/999/")
    assert response.status_code == 404
    assert response.json()["detail"] == "Resource not found"

    # Zero ID → 422
    response = test_app_with_db.get("/api/v1/resources/0/")
    assert response.status_code == 422


# ─── Read All (GET list) ────────────────────────────────────────────────────
# @source test_summaries.py line 83-98

def test_read_all_resources(test_app_with_db, sample_payload, monkeypatch):
    """Test listing all resources."""
    def mock_process(resource_id, url):
        return None

    # monkeypatch.setattr(module, "process_resource", mock_process)

    # Create one
    response = test_app_with_db.post(
        "/api/v1/resources/",
        content=json.dumps(sample_payload),
    )
    resource_id = response.json()["id"]

    # List all
    response = test_app_with_db.get("/api/v1/resources/")
    assert response.status_code == 200

    items = response.json()
    assert len([d for d in items if d["id"] == resource_id]) == 1


# ─── Delete (DELETE) ────────────────────────────────────────────────────────
# @source test_summaries.py line 101-134

def test_remove_resource(test_app_with_db, sample_payload, monkeypatch):
    """Test deleting a resource."""
    def mock_process(resource_id, url):
        return None

    # monkeypatch.setattr(module, "process_resource", mock_process)

    # Create
    response = test_app_with_db.post(
        "/api/v1/resources/",
        content=json.dumps(sample_payload),
    )
    resource_id = response.json()["id"]

    # Delete
    response = test_app_with_db.delete(f"/api/v1/resources/{resource_id}/")
    assert response.status_code == 200
    assert response.json()["id"] == resource_id


def test_remove_resource_incorrect_id(test_app_with_db):
    """Test 404 on delete of non-existent resource."""
    response = test_app_with_db.delete("/api/v1/resources/999/")
    assert response.status_code == 404
    assert response.json()["detail"] == "Resource not found"


# ─── Update (PUT) ───────────────────────────────────────────────────────────
# @source test_summaries.py line 137-238

def test_update_resource(test_app_with_db, sample_payload, monkeypatch):
    """Test updating a resource."""
    def mock_process(resource_id, url):
        return None

    # monkeypatch.setattr(module, "process_resource", mock_process)

    # Create
    response = test_app_with_db.post(
        "/api/v1/resources/",
        content=json.dumps(sample_payload),
    )
    resource_id = response.json()["id"]

    # Update
    update_payload = {
        "url": "https://example.com",
        "title": "Updated Title",
        "summary": "Updated summary",
    }
    response = test_app_with_db.put(
        f"/api/v1/resources/{resource_id}/",
        content=json.dumps(update_payload),
    )
    assert response.status_code == 200

    data = response.json()
    assert data["id"] == resource_id
    assert data["title"] == "Updated Title"
    assert data["summary"] == "Updated summary"


# @source test_summaries.py line 161-227 — parametrized invalid update
@pytest.mark.parametrize(
    "resource_id, payload, status_code, detail",
    [
        (
            999,
            {"url": "https://example.com", "summary": "updated!"},
            404,
            "Resource not found",
        ),
        (
            0,
            {"url": "https://example.com", "summary": "updated!"},
            422,
            [
                {
                    "type": "greater_than",
                    "loc": ["path", "id"],
                    "msg": "Input should be greater than 0",
                    "input": "0",
                    "ctx": {"gt": 0},
                }
            ],
        ),
        (
            1,
            {},
            422,
            [
                {
                    "type": "missing",
                    "loc": ["body", "url"],
                    "msg": "Field required",
                    "input": {},
                },
            ],
        ),
    ],
)
def test_update_resource_invalid(
    test_app_with_db,
    resource_id: int,
    payload: dict,
    status_code: int,
    detail: Any,
):
    """Parametrized negative test cases for update endpoint."""
    response = test_app_with_db.put(
        f"/api/v1/resources/{resource_id}/",
        content=json.dumps(payload),
    )
    assert response.status_code == status_code
    assert response.json()["detail"] == detail
