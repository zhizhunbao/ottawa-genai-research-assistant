import time
import uuid
from dataclasses import dataclass, field
from typing import Any, List, Optional
from .printer import Printer
from .tool_collection import ToolCollection

@dataclass
class AgentContext:
    """
    集中管理请求级上下文，贯穿整个 Agent 调度链。
    参考: joyagent-jdgenie (AgentContext.java)
    """
    request_id: str = field(default_factory=lambda: str(uuid.uuid4()))  # 请求追踪 ID
    session_id: str = field(default_factory=lambda: str(uuid.uuid4()))  # 会话 ID
    query: str = ""                       # 用户原始查询
    task: str = ""                        # 当前执行的子任务
    printer: Optional[Printer] = None     # 推流输出通道
    tool_collection: Optional[ToolCollection] = None  # 工具集合
    date_info: str = field(default_factory=lambda: time.strftime("%Y-%m-%d"))  # 当前日期 (注入给 Prompt)
    product_files: List[Any] = field(default_factory=list)  # 用户上传的文件
    is_stream: bool = False               # 是否流式输出
    stream_message_type: str = ""         # 当前流消息类型
    sop_prompt: str = ""                  # SOP 指令注入
    agent_type: int = 0                   # Agent 类型标识
    
    def __post_init__(self):
        if self.tool_collection and not self.tool_collection.context:
            self.tool_collection.context = self
