from typing import Any, Callable, Dict, List, Optional
from pydantic import BaseModel

class BaseTool(BaseModel):
    """
    工具基类.
    出处: joyagent-jdgenie (BaseTool.java)
    """
    name: str
    description: str
    parameters: Dict[str, Any] # JSON Schema 格式
    fn: Callable

    async def execute(self, **kwargs) -> Any:
        return await self.fn(**kwargs)

class ToolCollection:
    """
    G2. 工具集合管理器.
    负责工具的注册、查找和 Schema 生成.
    """
    def __init__(self):
        self._tools: Dict[str, BaseTool] = {}

    def register(self, tool: BaseTool):
        """注册工具."""
        self._tools[tool.name] = tool

    def get_tool(self, name: str) -> Optional[BaseTool]:
        """按名称查找工具."""
        return self._tools.get(name)

    def to_openai_tools(self) -> List[Dict[str, Any]]:
        """
        导出为 OpenAI 格式的 tools 定义.
        """
        return [
            {
                "type": "function",
                "function": {
                    "name": t.name,
                    "description": t.description,
                    "parameters": t.parameters
                }
            }
            for t in self._tools.values()
        ]

    async def run_tool(self, tool_name: str, arguments: Dict[str, Any]) -> str:
        """运行特定的工具并处理异常."""
        tool = self.get_tool(tool_name)
        if not tool:
            return f"Error: Tool {tool_name} not found."
        
        try:
            result = await tool.execute(**arguments)
            return str(result)
        except Exception as e:
            return f"Error executing {tool_name}: {str(e)}"
