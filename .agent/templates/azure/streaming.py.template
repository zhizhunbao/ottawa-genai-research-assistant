import json
import logging
from typing import AsyncGenerator, Dict, Any

logger = logging.getLogger(__name__)

async def format_as_ndjson(r: AsyncGenerator[Dict[str, Any], None]) -> AsyncGenerator[str, None]:
    """
    异步生成器 → NDJSON 流式 HTTP 响应。
    参考: azure-search-openai-demo (app.py)
    """
    try:
        async for event in r:
            # 使用 ensure_ascii=False 支持中文
            yield json.dumps(event, ensure_ascii=False) + "\n"
    except Exception as error:
        logger.exception("Exception while generating response stream: %s", error)
        yield json.dumps({"error": str(error)}, ensure_ascii=False) + "\n"

# 使用示例 (基于 FastAPI):
# @app.post("/chat")
# async def chat_handler(request: Request):
#     result_gen = approach.run_stream(messages)
#     return StreamingResponse(
#         format_as_ndjson(result_gen),
#         media_type="application/json-lines"
#     )
