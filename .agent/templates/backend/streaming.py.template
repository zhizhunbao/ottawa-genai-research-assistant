"""
Streaming Response

SSE (Server-Sent Events) 流式响应支持。
"""

import json
from typing import AsyncIterator, Any

from fastapi import APIRouter
from fastapi.responses import StreamingResponse


router = APIRouter()


async def event_generator(
    data_stream: AsyncIterator[Any],
    event_type: str = "message",
) -> AsyncIterator[str]:
    """
    SSE 事件生成器

    Args:
        data_stream: 数据流
        event_type: 事件类型

    Yields:
        SSE 格式的字符串
    """
    try:
        async for data in data_stream:
            if isinstance(data, dict):
                payload = json.dumps(data, ensure_ascii=False)
            else:
                payload = str(data)

            yield f"event: {event_type}\ndata: {payload}\n\n"

    except Exception as e:
        yield f"event: error\ndata: {json.dumps({'error': str(e)})}\n\n"

    finally:
        yield "event: done\ndata: [DONE]\n\n"


def create_sse_response(
    data_stream: AsyncIterator[Any],
    event_type: str = "message",
) -> StreamingResponse:
    """创建 SSE 响应"""
    return StreamingResponse(
        event_generator(data_stream, event_type),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "X-Accel-Buffering": "no",
        },
    )


# ============================================
# Example Usage
# ============================================

# @router.post("/chat/stream")
# async def chat_stream(request: ChatRequest):
#     async def generate():
#         async for chunk in openai_service.stream(request.messages):
#             yield {"content": chunk}
#
#     return create_sse_response(generate())
