from typing import Any
import uuid
from fastapi import APIRouter, Depends, HTTPException
from sqlmodel import select, func

from app.api.deps import SessionDep, CurrentUser
from .schemas import (
    {{FeatureName}}Public, 
    {{FeatureName}}sPublic, 
    {{FeatureName}}Create, 
    {{FeatureName}}Update
)
from .models import {{FeatureName}}

router = APIRouter(prefix="/{{feature_name}}s", tags=["{{feature_name}}s"])

@router.get("/", response_model={{FeatureName}}sPublic)
def read_{{feature_name}}s(
    session: SessionDep, 
    current_user: CurrentUser, 
    skip: int = 0, 
    limit: int = 100
) -> Any:
    """
    A7. API 路由.
    出处: full-stack-fastapi-template
    """
    count_statement = select(func.count()).select_from({{FeatureName}})
    count = session.exec(count_statement).one()
    statement = select({{FeatureName}}).offset(skip).limit(limit)
    items = session.exec(statement).all()
    return {{FeatureName}}sPublic(data=items, count=count)

@router.get("/{id}", response_model={{FeatureName}}Public)
def read_{{feature_name}}(
    session: SessionDep, 
    current_user: CurrentUser, 
    id: uuid.UUID
) -> Any:
    item = session.get({{FeatureName}}, id)
    if not item:
        raise HTTPException(status_code=404, detail="{{FeatureName}} not found")
    if not current_user.is_superuser and (item.owner_id != current_user.id):
        raise HTTPException(status_code=400, detail="Not enough permissions")
    return item

@router.post("/", response_model={{FeatureName}}Public)
def create_{{feature_name}}(
    *, 
    session: SessionDep, 
    current_user: CurrentUser, 
    item_in: {{FeatureName}}Create
) -> Any:
    item = {{FeatureName}}.model_validate(item_in, update={"owner_id": current_user.id})
    session.add(item)
    session.commit()
    session.refresh(item)
    return item

@router.put("/{id}", response_model={{FeatureName}}Public)
def update_{{feature_name}}(
    *, 
    session: SessionDep, 
    current_user: CurrentUser, 
    id: uuid.UUID, 
    item_in: {{FeatureName}}Update
) -> Any:
    item = session.get({{FeatureName}}, id)
    if not item:
        raise HTTPException(status_code=404, detail="{{FeatureName}} not found")
    if not current_user.is_superuser and (item.owner_id != current_user.id):
        raise HTTPException(status_code=400, detail="Not enough permissions")
    update_dict = item_in.model_dump(exclude_unset=True)
    item.sqlmodel_update(update_dict)
    session.add(item)
    session.commit()
    session.refresh(item)
    return item

@router.delete("/{id}")
def delete_{{feature_name}}(
    session: SessionDep, 
    current_user: CurrentUser, 
    id: uuid.UUID
) -> Any:
    item = session.get({{FeatureName}}, id)
    if not item:
        raise HTTPException(status_code=404, detail="{{FeatureName}} not found")
    if not current_user.is_superuser and (item.owner_id != current_user.id):
        raise HTTPException(status_code=400, detail="Not enough permissions")
    session.delete(item)
    session.commit()
    return {"message": "{{FeatureName}} deleted successfully"}
