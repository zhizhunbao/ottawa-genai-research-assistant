"""
Azure Service Factory

统一创建和管理 Azure 服务实例。
"""

from functools import lru_cache
from typing import Optional

from .config import get_azure_config, AzureConfig
from .openai import AzureOpenAIService
from .search import AzureSearchService
from .storage import AzureStorageService


class AzureServiceFactory:
    """Azure 服务工厂"""

    def __init__(self, config: Optional[AzureConfig] = None):
        self._config = config or get_azure_config()
        self._openai: Optional[AzureOpenAIService] = None
        self._search: Optional[AzureSearchService] = None
        self._storage: Optional[AzureStorageService] = None

    @property
    def openai(self) -> Optional[AzureOpenAIService]:
        if not self._openai and self._config.openai:
            self._openai = AzureOpenAIService(self._config.openai)
        return self._openai

    @property
    def search(self) -> Optional[AzureSearchService]:
        if not self._search and self._config.search:
            # 注入 embedding 函数实现混合搜索
            embedding_fn = self.openai.embed if self.openai else None
            self._search = AzureSearchService(self._config.search, embedding_fn)
        return self._search

    @property
    def storage(self) -> Optional[AzureStorageService]:
        if not self._storage and self._config.storage:
            self._storage = AzureStorageService(self._config.storage)
        return self._storage

    async def close(self):
        """关闭所有服务连接"""
        if self._search:
            await self._search.close()
        if self._storage:
            await self._storage.close()


@lru_cache
def get_service_factory() -> AzureServiceFactory:
    """获取服务工厂单例"""
    return AzureServiceFactory()
