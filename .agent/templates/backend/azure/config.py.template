"""
Azure 服务配置

使用 Pydantic Settings 管理 Azure 服务配置。
"""

from functools import lru_cache
from typing import Optional

from pydantic import Field, field_validator
from pydantic_settings import BaseSettings, SettingsConfigDict


class AzureOpenAIConfig(BaseSettings):
    """Azure OpenAI 配置"""

    model_config = SettingsConfigDict(
        env_prefix="AZURE_OPENAI_",
        extra="ignore",
    )

    endpoint: str = Field(..., description="Azure OpenAI endpoint URL")
    api_key: str = Field(..., description="API Key")
    api_version: str = Field(default="2024-02-15-preview")

    # 模型部署名称
    chat_deployment: str = Field(default="gpt-4o-mini")
    embedding_deployment: str = Field(default="text-embedding-ada-002")

    # 默认参数
    default_temperature: float = Field(default=0.7, ge=0, le=2)
    default_max_tokens: int = Field(default=4096, ge=1)

    @field_validator("endpoint")
    @classmethod
    def validate_endpoint(cls, v: str) -> str:
        if not v.startswith("https://"):
            raise ValueError("Endpoint must start with https://")
        return v.rstrip("/")


class AzureSearchConfig(BaseSettings):
    """Azure AI Search 配置"""

    model_config = SettingsConfigDict(
        env_prefix="AZURE_SEARCH_",
        extra="ignore",
    )

    endpoint: str = Field(..., description="Azure Search endpoint URL")
    api_key: str = Field(..., description="Admin API Key")
    index_name: str = Field(default="documents")

    # 搜索参数
    default_top_k: int = Field(default=5, ge=1, le=50)
    vector_dimensions: int = Field(default=1536)

    # 语义搜索
    semantic_config: Optional[str] = Field(default=None)

    @field_validator("endpoint")
    @classmethod
    def validate_endpoint(cls, v: str) -> str:
        if not v.startswith("https://"):
            raise ValueError("Endpoint must start with https://")
        return v.rstrip("/")


class AzureStorageConfig(BaseSettings):
    """Azure Blob Storage 配置"""

    model_config = SettingsConfigDict(
        env_prefix="AZURE_STORAGE_",
        extra="ignore",
    )

    connection_string: str = Field(..., description="Storage connection string")
    container_name: str = Field(default="documents")

    # 上传限制
    max_file_size_mb: int = Field(default=100)
    allowed_extensions: list[str] = Field(
        default=["pdf", "docx", "txt", "md"]
    )


class AzureConfig(BaseSettings):
    """Azure 服务总配置"""

    model_config = SettingsConfigDict(extra="ignore")

    # 子配置 (可选，允许部分服务未配置)
    openai: Optional[AzureOpenAIConfig] = None
    search: Optional[AzureSearchConfig] = None
    storage: Optional[AzureStorageConfig] = None

    # 通用配置
    tenant_id: str = Field(default="", alias="AZURE_TENANT_ID")
    client_id: str = Field(default="", alias="AZURE_CLIENT_ID")

    # 重试配置
    max_retries: int = Field(default=3)
    retry_delay: float = Field(default=1.0)

    @classmethod
    def from_env(cls) -> "AzureConfig":
        """从环境变量加载配置"""
        openai = None
        search = None
        storage = None

        # 尝试加载各服务配置
        try:
            openai = AzureOpenAIConfig()
        except Exception:
            pass

        try:
            search = AzureSearchConfig()
        except Exception:
            pass

        try:
            storage = AzureStorageConfig()
        except Exception:
            pass

        return cls(
            openai=openai,
            search=search,
            storage=storage,
        )


@lru_cache
def get_azure_config() -> AzureConfig:
    """获取 Azure 配置（缓存）"""
    return AzureConfig.from_env()
