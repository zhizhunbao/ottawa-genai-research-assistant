/**
 * SearchInput - Debounced search input with icon, clear button, and keyboard shortcut
 *
 * @module shared/components/ui/search-input
 * @source shadcn-admin/src/components/search.tsx (38L)
 * @reference https://github.com/satnaing/shadcn-admin
 * @template S2-M1-F1
 *
 * Features:
 * - Search icon prefix
 * - Clear button on non-empty input
 * - Debounced onChange with configurable delay (default 300ms)
 * - ⌘K keyboard shortcut indicator
 * - Supports controlled and uncontrolled modes
 * - Focus ring on keyboard navigation
 *
 * Usage:
 * ```tsx
 * // Uncontrolled with debounced callback
 * <SearchInput
 *   placeholder="Search documents..."
 *   onSearch={(query) => console.log(query)}
 *   debounceMs={500}
 * />
 *
 * // Controlled mode
 * <SearchInput
 *   value={searchTerm}
 *   onChange={setSearchTerm}
 *   placeholder="Filter results..."
 * />
 *
 * // With keyboard shortcut trigger
 * <SearchInput
 *   showShortcut
 *   onShortcutClick={() => openCommandPalette()}
 * />
 * ```
 */

import * as React from "react";

// ─── Types ───────────────────────────────────────────────────────────────────

export interface SearchInputProps
  extends Omit<React.InputHTMLAttributes<HTMLInputElement>, "onChange"> {
  /** Callback fired after debounce with the search query */
  onSearch?: (query: string) => void;
  /** Controlled value */
  value?: string;
  /** Controlled onChange */
  onChange?: (value: string) => void;
  /** Debounce delay in milliseconds (default: 300) */
  debounceMs?: number;
  /** Show ⌘K keyboard shortcut badge */
  showShortcut?: boolean;
  /** Callback when shortcut badge is clicked */
  onShortcutClick?: () => void;
  /** Additional CSS class names */
  className?: string;
}

// ─── Styles ──────────────────────────────────────────────────────────────────

const styles = {
  wrapper: [
    "search-input-wrapper",
    "relative flex items-center w-full",
  ].join(" "),

  icon: [
    "search-input-icon",
    "absolute left-3 top-1/2 -translate-y-1/2",
    "h-4 w-4 text-[var(--color-muted-foreground)]",
    "pointer-events-none",
  ].join(" "),

  input: [
    "search-input",
    "h-9 w-full rounded-md border border-[var(--color-border)]",
    "bg-[var(--color-background)] px-9 py-2 text-sm",
    "placeholder:text-[var(--color-muted-foreground)]",
    "focus-visible:outline-none focus-visible:ring-2",
    "focus-visible:ring-[var(--color-ring)] focus-visible:ring-offset-2",
    "disabled:cursor-not-allowed disabled:opacity-50",
    "transition-colors duration-200",
  ].join(" "),

  clearButton: [
    "search-input-clear",
    "absolute right-2 top-1/2 -translate-y-1/2",
    "flex items-center justify-center",
    "h-5 w-5 rounded-sm",
    "text-[var(--color-muted-foreground)]",
    "hover:text-[var(--color-foreground)]",
    "hover:bg-[var(--color-accent)]",
    "focus-visible:outline-none focus-visible:ring-2",
    "cursor-pointer transition-colors",
  ].join(" "),

  shortcutBadge: [
    "search-input-shortcut",
    "pointer-events-none absolute right-2 top-1/2 -translate-y-1/2",
    "hidden sm:flex items-center gap-0.5",
    "h-5 rounded border border-[var(--color-border)]",
    "bg-[var(--color-muted)] px-1.5",
    "font-mono text-[10px] font-medium",
    "text-[var(--color-muted-foreground)]",
    "select-none",
  ].join(" "),

  shortcutClickable: [
    "pointer-events-auto cursor-pointer",
    "hover:bg-[var(--color-accent)]",
  ].join(" "),
} as const;

// ─── Hook: useDebounce ───────────────────────────────────────────────────────

function useDebounce<T>(value: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = React.useState<T>(value);

  React.useEffect(() => {
    const timer = setTimeout(() => setDebouncedValue(value), delay);
    return () => clearTimeout(timer);
  }, [value, delay]);

  return debouncedValue;
}

// ─── Search Icon (inline SVG to avoid lucide dependency) ─────────────────────

const SearchIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="16"
    height="16"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    className={className}
    aria-hidden="true"
  >
    <circle cx="11" cy="11" r="8" />
    <path d="m21 21-4.3-4.3" />
  </svg>
);

// ─── X Icon (inline SVG) ────────────────────────────────────────────────────

const XIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    className={className}
    aria-hidden="true"
  >
    <path d="M18 6 6 18" />
    <path d="m6 6 12 12" />
  </svg>
);

// ─── Component ───────────────────────────────────────────────────────────────

export const SearchInput = React.forwardRef<HTMLInputElement, SearchInputProps>(
  (
    {
      onSearch,
      value: controlledValue,
      onChange: controlledOnChange,
      debounceMs = 300,
      showShortcut = false,
      onShortcutClick,
      className = "",
      placeholder = "Search...",
      ...inputProps
    },
    ref
  ) => {
    // Internal state for uncontrolled mode
    const [internalValue, setInternalValue] = React.useState("");
    const isControlled = controlledValue !== undefined;
    const currentValue = isControlled ? controlledValue : internalValue;

    // Debounced value for onSearch callback
    const debouncedValue = useDebounce(currentValue, debounceMs);

    // Fire onSearch when debounced value changes
    React.useEffect(() => {
      onSearch?.(debouncedValue);
    }, [debouncedValue, onSearch]);

    // Handle input change
    const handleChange = React.useCallback(
      (e: React.ChangeEvent<HTMLInputElement>) => {
        const newValue = e.target.value;
        if (isControlled) {
          controlledOnChange?.(newValue);
        } else {
          setInternalValue(newValue);
        }
      },
      [isControlled, controlledOnChange]
    );

    // Handle clear
    const handleClear = React.useCallback(() => {
      if (isControlled) {
        controlledOnChange?.("");
      } else {
        setInternalValue("");
      }
      onSearch?.("");
    }, [isControlled, controlledOnChange, onSearch]);

    // Keyboard shortcut (⌘K / Ctrl+K)
    const inputRef = React.useRef<HTMLInputElement>(null);
    React.useImperativeHandle(ref, () => inputRef.current!);

    React.useEffect(() => {
      const handleKeyDown = (e: KeyboardEvent) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          if (onShortcutClick) {
            onShortcutClick();
          } else {
            inputRef.current?.focus();
          }
        }
      };
      document.addEventListener("keydown", handleKeyDown);
      return () => document.removeEventListener("keydown", handleKeyDown);
    }, [onShortcutClick]);

    const hasValue = currentValue.length > 0;
    const showClear = hasValue && !showShortcut;

    return (
      <div className={`${styles.wrapper} ${className}`}>
        <SearchIcon className={styles.icon} />

        <input
          ref={inputRef}
          type="search"
          value={currentValue}
          onChange={handleChange}
          placeholder={placeholder}
          className={`${styles.input} ${
            showShortcut && !hasValue ? "pr-16" : ""
          }`}
          aria-label={placeholder}
          {...inputProps}
        />

        {showClear && (
          <button
            type="button"
            onClick={handleClear}
            className={styles.clearButton}
            aria-label="Clear search"
          >
            <XIcon />
          </button>
        )}

        {showShortcut && !hasValue && (
          <kbd
            className={`${styles.shortcutBadge} ${
              onShortcutClick ? styles.shortcutClickable : ""
            }`}
            onClick={onShortcutClick}
          >
            <span className="text-xs">⌘</span>K
          </kbd>
        )}
      </div>
    );
  }
);

SearchInput.displayName = "SearchInput";

export default SearchInput;
