/**
 * Notification System - Toast notifications with Zustand store
 *
 * @module shared/components/ui/notification
 * @source bulletproof-react/apps/react-vite/src/components/ui/notifications/ (4 files, ~108L)
 *   - notification.tsx (53L) — single notification card
 *   - notifications.tsx (22L) — notification container
 *   - notifications-store.ts (33L) — zustand store
 * @reference https://github.com/alan2207/bulletproof-react
 * @template S2-M1-F4
 *
 * Features:
 * - Four notification types: info, success, warning, error
 * - Auto-dismiss with configurable duration (default 5s)
 * - Manual dismiss via close button
 * - Zustand-based notification store (framework-agnostic)
 * - Slide-in animation from top-right
 * - Accessible: role="alert", aria-live="assertive"
 * - Max visible notifications limit
 *
 * Usage:
 * ```tsx
 * // 1. Add <Notifications /> to your app root (inside providers)
 * <Notifications />
 *
 * // 2. Use the store to add notifications from anywhere
 * import { useNotifications } from './notification';
 *
 * const { addNotification } = useNotifications();
 * addNotification({ type: 'success', title: 'Saved!', message: 'Document saved.' });
 * addNotification({ type: 'error', title: 'Error', message: 'Something went wrong.' });
 * ```
 */

import * as React from "react";

// ─── Types ───────────────────────────────────────────────────────────────────

export type NotificationType = "info" | "success" | "warning" | "error";

export interface NotificationData {
  id: string;
  type: NotificationType;
  title: string;
  message?: string;
  duration?: number; // ms, 0 = manual dismiss only
}

// ─── Notification Store (vanilla — replace with zustand if available) ─────────
// @source notifications-store.ts (33L)

type NotificationsState = {
  notifications: NotificationData[];
  addNotification: (notification: Omit<NotificationData, "id">) => void;
  dismissNotification: (id: string) => void;
};

let notificationId = 0;
const generateId = () => `notification-${++notificationId}-${Date.now()}`;

// Simple store implementation (zustand-like pattern without dependency)
const listeners = new Set<() => void>();
let state: NotificationsState;

const setState = (
  updater: (prev: NotificationsState) => Partial<NotificationsState>
) => {
  state = { ...state, ...updater(state) };
  listeners.forEach((listener) => listener());
};

state = {
  notifications: [],
  addNotification: (notification) => {
    setState((prev) => ({
      notifications: [
        ...prev.notifications,
        { id: generateId(), duration: 5000, ...notification },
      ],
    }));
  },
  dismissNotification: (id) => {
    setState((prev) => ({
      notifications: prev.notifications.filter((n) => n.id !== id),
    }));
  },
};

/** Hook to access notification store */
export function useNotifications(): NotificationsState {
  const [, forceUpdate] = React.useReducer((x: number) => x + 1, 0);

  React.useEffect(() => {
    listeners.add(forceUpdate);
    return () => {
      listeners.delete(forceUpdate);
    };
  }, []);

  return state;
}

/** Imperative API for non-React contexts */
export const notifications = {
  add: (notification: Omit<NotificationData, "id">) =>
    state.addNotification(notification),
  dismiss: (id: string) => state.dismissNotification(id),
  success: (title: string, message?: string) =>
    state.addNotification({ type: "success", title, message }),
  error: (title: string, message?: string) =>
    state.addNotification({ type: "error", title, message }),
  info: (title: string, message?: string) =>
    state.addNotification({ type: "info", title, message }),
  warning: (title: string, message?: string) =>
    state.addNotification({ type: "warning", title, message }),
};

// ─── Icon Components (inline SVG) ────────────────────────────────────────────

const iconColors: Record<NotificationType, string> = {
  info: "text-blue-500",
  success: "text-green-500",
  warning: "text-yellow-500",
  error: "text-red-500",
};

const InfoIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg" width="24" height="24"
    viewBox="0 0 24 24" fill="none" stroke="currentColor"
    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
    className={className} aria-hidden="true"
  >
    <circle cx="12" cy="12" r="10" />
    <path d="M12 16v-4" />
    <path d="M12 8h.01" />
  </svg>
);

const CheckCircleIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg" width="24" height="24"
    viewBox="0 0 24 24" fill="none" stroke="currentColor"
    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
    className={className} aria-hidden="true"
  >
    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
    <polyline points="22 4 12 14.01 9 11.01" />
  </svg>
);

const AlertTriangleIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg" width="24" height="24"
    viewBox="0 0 24 24" fill="none" stroke="currentColor"
    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
    className={className} aria-hidden="true"
  >
    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
    <path d="M12 9v4" />
    <path d="M12 17h.01" />
  </svg>
);

const XCircleIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg" width="24" height="24"
    viewBox="0 0 24 24" fill="none" stroke="currentColor"
    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
    className={className} aria-hidden="true"
  >
    <circle cx="12" cy="12" r="10" />
    <path d="m15 9-6 6" />
    <path d="m9 9 6 6" />
  </svg>
);

const XIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg" width="20" height="20"
    viewBox="0 0 24 24" fill="none" stroke="currentColor"
    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
    className={className} aria-hidden="true"
  >
    <path d="M18 6 6 18" />
    <path d="m6 6 12 12" />
  </svg>
);

const iconComponents: Record<NotificationType, React.FC<{ className?: string }>> = {
  info: InfoIcon,
  success: CheckCircleIcon,
  warning: AlertTriangleIcon,
  error: XCircleIcon,
};

// ─── Notification Card ───────────────────────────────────────────────────────
// @source notification.tsx (53L)

interface NotificationCardProps {
  notification: NotificationData;
  onDismiss: (id: string) => void;
}

const NotificationCard: React.FC<NotificationCardProps> = ({
  notification: { id, type, title, message },
  onDismiss,
}) => {
  const Icon = iconComponents[type];

  return (
    <div
      className="pointer-events-auto w-full max-w-sm overflow-hidden rounded-lg bg-[var(--color-card)] shadow-lg ring-1 ring-black/5 animate-in slide-in-from-top-2 fade-in duration-300"
      style={{ animationFillMode: "forwards" }}
    >
      <div className="p-4" role="alert" aria-label={title}>
        <div className="flex items-start">
          <div className="shrink-0">
            <Icon className={`h-5 w-5 ${iconColors[type]}`} />
          </div>
          <div className="ml-3 w-0 flex-1 pt-0.5">
            <p className="text-sm font-medium text-[var(--color-card-foreground)]">
              {title}
            </p>
            {message && (
              <p className="mt-1 text-sm text-[var(--color-muted-foreground)]">
                {message}
              </p>
            )}
          </div>
          <div className="ml-4 flex shrink-0">
            <button
              className="inline-flex rounded-md text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] focus:outline-none focus:ring-2 focus:ring-[var(--color-ring)] focus:ring-offset-2 transition-colors"
              onClick={() => onDismiss(id)}
              aria-label="Dismiss notification"
            >
              <XIcon className="h-5 w-5" />
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// ─── Notifications Container ─────────────────────────────────────────────────
// @source notifications.tsx (22L)

const MAX_VISIBLE = 5;

export const Notifications: React.FC = () => {
  const { notifications: items, dismissNotification } = useNotifications();

  // Auto-dismiss with timer
  React.useEffect(() => {
    const timers: ReturnType<typeof setTimeout>[] = [];
    items.forEach((item) => {
      if (item.duration && item.duration > 0) {
        const timer = setTimeout(() => {
          dismissNotification(item.id);
        }, item.duration);
        timers.push(timer);
      }
    });
    return () => timers.forEach(clearTimeout);
  }, [items, dismissNotification]);

  const visibleItems = items.slice(-MAX_VISIBLE);

  return (
    <div
      aria-live="assertive"
      className="pointer-events-none fixed inset-0 z-[100] flex flex-col items-end space-y-3 p-4 sm:p-6"
    >
      {visibleItems.map((notification) => (
        <NotificationCard
          key={notification.id}
          notification={notification}
          onDismiss={dismissNotification}
        />
      ))}
    </div>
  );
};

Notifications.displayName = "Notifications";

export default Notifications;
