/**
 * ConversationLayout - Three-column chat page layout (sidebar + main + input)
 *
 * The top-level layout component for the chat page. Combines:
 * - Left sidebar: topic/conversation list
 * - Center: message list with header
 * - Bottom: chat input area
 *
 * @module features/chat/components
 * @source lobe-chat/src/features/Conversation/ (overall page structure)
 * @source chatbot-ui/components/chat/chat-ui.tsx (231 lines — ChatUI layout)
 * @reference https://github.com/lobehub/lobe-chat
 * @reference https://github.com/mckaywrigley/chatbot-ui
 * @template S1-M5-6 frontend/features/chat/components/conversation-layout.tsx
 */

'use client'

import { memo, type ReactNode, useState } from 'react'
import { PanelLeft, Plus, Settings } from 'lucide-react'

// ============================================================
// Types
// ============================================================

export interface ConversationLayoutProps {
  /** Sidebar content — typically a TopicList component */
  sidebar?: ReactNode
  /** Header bar content — model selector, settings button, etc. */
  headerContent?: ReactNode
  /** The message list area */
  messageList: ReactNode
  /** The chat input area */
  chatInput: ReactNode
  /** Welcome screen shown when no messages */
  welcome?: ReactNode
  /** Title displayed in the header */
  title?: string
  /** Whether the sidebar is visible */
  sidebarOpen?: boolean
  /** Toggle sidebar handler */
  onToggleSidebar?: () => void
  /** New conversation handler */
  onNewConversation?: () => void
}

// ============================================================
// Component
// ============================================================

/**
 * ConversationLayout — assembles the full chat page.
 *
 * Layout structure mirrors chatbot-ui/chat-ui.tsx:
 * ```
 * ┌─────────────────────────────────────────────┐
 * │ Sidebar │        Header (title + actions)    │
 * │         │────────────────────────────────────│
 * │ Topics  │                                    │
 * │ List    │        Message List                │
 * │         │        (scrollable)                │
 * │         │                                    │
 * │         │────────────────────────────────────│
 * │         │        Chat Input                  │
 * └─────────────────────────────────────────────┘
 * ```
 *
 * @source chatbot-ui chat-ui.tsx lines 188-228
 * @source lobe-chat Conversation/ (overall page structure)
 */
export const ConversationLayout = memo<ConversationLayoutProps>(
  ({
    sidebar,
    headerContent,
    messageList,
    chatInput,
    welcome,
    title,
    sidebarOpen: sidebarOpenProp,
    onToggleSidebar,
    onNewConversation,
  }) => {
    const [internalSidebarOpen, setInternalSidebarOpen] = useState(true)
    const sidebarOpen = sidebarOpenProp ?? internalSidebarOpen
    const toggleSidebar = onToggleSidebar ?? (() => setInternalSidebarOpen((prev) => !prev))

    return (
      <div
        style={{
          display: 'flex',
          height: '100vh',
          width: '100%',
          overflow: 'hidden',
          background: 'var(--color-bg, #ffffff)',
        }}
      >
        {/* ================================================ */}
        {/* Sidebar                                          */}
        {/* ================================================ */}
        {sidebar && (
          <aside
            style={{
              width: sidebarOpen ? 280 : 0,
              minWidth: sidebarOpen ? 280 : 0,
              height: '100%',
              borderRight: sidebarOpen ? '1px solid var(--color-border, #e2e8f0)' : 'none',
              background: 'var(--color-bg-sidebar, #f8fafc)',
              transition: 'width 200ms ease-out, min-width 200ms ease-out',
              overflow: 'hidden',
              display: 'flex',
              flexDirection: 'column',
            }}
          >
            {/* Sidebar header */}
            <div
              style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '12px 16px',
                borderBottom: '1px solid var(--color-border, #e2e8f0)',
                flexShrink: 0,
              }}
            >
              <span
                style={{
                  fontSize: 14,
                  fontWeight: 600,
                  color: 'var(--color-text, #334155)',
                }}
              >
                Conversations
              </span>

              {onNewConversation && (
                <button
                  onClick={onNewConversation}
                  title="New conversation"
                  style={{
                    width: 28,
                    height: 28,
                    borderRadius: 6,
                    border: 'none',
                    background: 'var(--color-primary, #6366f1)',
                    color: '#fff',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    transition: 'opacity 150ms',
                  }}
                >
                  <Plus size={14} />
                </button>
              )}
            </div>

            {/* Sidebar body */}
            <div style={{ flex: 1, overflowY: 'auto' }}>{sidebar}</div>
          </aside>
        )}

        {/* ================================================ */}
        {/* Main Content Area                                */}
        {/* ================================================ */}
        <main
          style={{
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            height: '100%',
            position: 'relative',
            overflow: 'hidden',
          }}
        >
          {/* Header */}
          <header
            style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              padding: '8px 16px',
              borderBottom: '1px solid var(--color-border, #e2e8f0)',
              minHeight: 48,
              flexShrink: 0,
              background: 'var(--color-bg, #fff)',
            }}
          >
            {/* Left: Toggle + Title */}
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <button
                onClick={toggleSidebar}
                title={sidebarOpen ? 'Close sidebar' : 'Open sidebar'}
                style={{
                  width: 32,
                  height: 32,
                  borderRadius: 6,
                  border: 'none',
                  background: 'transparent',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  color: 'var(--color-text-secondary, #64748b)',
                  transition: 'background 150ms',
                }}
              >
                <PanelLeft size={18} />
              </button>

              {title && (
                <span
                  style={{
                    fontSize: 14,
                    fontWeight: 600,
                    color: 'var(--color-text, #334155)',
                    maxWidth: 300,
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap',
                  }}
                >
                  {title}
                </span>
              )}
            </div>

            {/* Right: Header content (model selector, settings, etc.) */}
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              {headerContent}
            </div>
          </header>

          {/* Message Area */}
          <div style={{ flex: 1, overflow: 'hidden', position: 'relative' }}>
            {messageList}
          </div>

          {/* Chat Input */}
          <div
            style={{
              padding: '12px 16px 16px',
              borderTop: '1px solid var(--color-border, #e2e8f0)',
              background: 'var(--color-bg, #fff)',
              flexShrink: 0,
              display: 'flex',
              justifyContent: 'center',
            }}
          >
            <div style={{ width: '100%', maxWidth: 800 }}>{chatInput}</div>
          </div>
        </main>
      </div>
    )
  }
)

ConversationLayout.displayName = 'ConversationLayout'
