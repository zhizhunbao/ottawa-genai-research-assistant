/**
 * DocumentUploadSteps - 3-step document upload wizard with drag-drop, preview, and processing
 *
 * Step 1: Upload — Drag-drop file selection → batch upload to backend
 * Step 2: Preview — Configure chunking params → preview generated chunks
 * Step 3: Process — Start background chunking/embedding → poll task status
 *
 * @module features/documents/upload
 * @source rag-web-ui/frontend/src/components/knowledge-base/document-upload-steps.tsx (full 689-line component)
 * @reference https://github.com/xyb/rag-web-ui
 * @template S1-M2-2 frontend/features/documents/upload/document-upload-steps.tsx
 */

import React, { useState, useCallback } from 'react'
import { useDropzone } from 'react-dropzone'
import {
  Upload,
  X,
  FileText,
  Settings,
  Loader2,
  CheckCircle,
  AlertCircle,
} from 'lucide-react'
import { Button } from '{{ALIAS}}/shared/components/ui/button'
import { Card } from '{{ALIAS}}/shared/components/ui/card'
import { Input } from '{{ALIAS}}/shared/components/ui/input'
import { Label } from '{{ALIAS}}/shared/components/ui/label'
import { Progress } from '{{ALIAS}}/shared/components/ui/progress'
import { Badge } from '{{ALIAS}}/shared/components/ui/badge'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '{{ALIAS}}/shared/components/ui/select'
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '{{ALIAS}}/shared/components/ui/accordion'
import { cn } from '{{ALIAS}}/shared/lib/utils'
import type {
  FileStatus,
  UploadResult,
  PreviewResponse,
  PreviewChunk,
  TaskStatus,
  TaskStatusMap,
  ProcessingTaskResponse,
} from './types'
import {
  ACCEPTED_FILE_TYPES,
  DEFAULT_CHUNKING_CONFIG,
} from './types'

// ============================================================
// Component Props
// ============================================================

interface DocumentUploadStepsProps {
  /** Knowledge base or collection ID to upload into */
  knowledgeBaseId: number | string

  /** Callback when all files are processed successfully */
  onComplete?: () => void

  /** API base URL */
  apiBaseUrl?: string

  /** Custom fetch function (for auth headers) */
  fetchFn?: (url: string, init?: RequestInit) => Promise<Response>
}

// ============================================================
// Stepper Header
// ============================================================

const STEPS = [
  { step: 1, icon: Upload, label: 'Upload' },
  { step: 2, icon: FileText, label: 'Preview' },
  { step: 3, icon: Settings, label: 'Process' },
] as const

interface StepperProps {
  currentStep: number
}

/**
 * Visual stepper header showing current progress.
 *
 * @source rag-web-ui document-upload-steps.tsx lines 354-391
 */
function Stepper({ currentStep }: StepperProps) {
  return (
    <div className="mb-8">
      <div className="flex justify-between mb-2">
        {STEPS.map(({ step, icon: Icon, label }, index) => (
          <div key={step} className="flex flex-col items-center space-y-2 flex-1">
            <div
              className={cn(
                'w-12 h-12 rounded-full flex items-center justify-center border-2 transition-colors',
                currentStep === step
                  ? 'bg-primary text-primary-foreground border-primary'
                  : currentStep > step
                    ? 'bg-primary/20 border-primary/20 text-primary'
                    : 'bg-background border-input text-muted-foreground'
              )}
            >
              {currentStep > step ? (
                <CheckCircle className="w-6 h-6" />
              ) : (
                <Icon className="w-6 h-6" />
              )}
            </div>
            <span className={cn(
              'text-sm font-medium',
              currentStep >= step ? 'text-foreground' : 'text-muted-foreground'
            )}>
              {step}. {label}
            </span>
          </div>
        ))}
      </div>
    </div>
  )
}

// ============================================================
// File Status Badge
// ============================================================

function StatusBadge({ status }: { status: FileStatus['status'] }) {
  const variants: Record<FileStatus['status'], { variant: 'default' | 'secondary' | 'destructive' | 'outline'; label: string }> = {
    pending: { variant: 'outline', label: 'Pending' },
    uploading: { variant: 'default', label: 'Uploading...' },
    uploaded: { variant: 'secondary', label: 'Uploaded' },
    processing: { variant: 'default', label: 'Processing...' },
    completed: { variant: 'secondary', label: 'Ready' },
    error: { variant: 'destructive', label: 'Error' },
  }

  const { variant, label } = variants[status]
  return <Badge variant={variant}>{label}</Badge>
}

// ============================================================
// Main Component
// ============================================================

/**
 * Multi-step document upload wizard.
 *
 * @source rag-web-ui document-upload-steps.tsx — full component (689 lines)
 */
export function DocumentUploadSteps({
  knowledgeBaseId,
  onComplete,
  apiBaseUrl = '{{API_BASE_URL}}',
  fetchFn,
}: DocumentUploadStepsProps) {
  const [currentStep, setCurrentStep] = useState(1)
  const [files, setFiles] = useState<FileStatus[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [chunkSize, setChunkSize] = useState(DEFAULT_CHUNKING_CONFIG.chunkSize)
  const [chunkOverlap, setChunkOverlap] = useState(DEFAULT_CHUNKING_CONFIG.chunkOverlap)
  const [selectedDocumentId, setSelectedDocumentId] = useState<number | null>(null)
  const [previewData, setPreviewData] = useState<Record<number, PreviewResponse>>({})
  const [taskStatuses, setTaskStatuses] = useState<TaskStatusMap>({})

  // Helper for API calls — allows injecting auth headers via fetchFn
  const apiFetch = useCallback(
    async (url: string, options?: RequestInit) => {
      const fn = fetchFn || fetch
      const res = await fn(`${apiBaseUrl}${url}`, options)
      if (!res.ok) {
        const err = await res.json().catch(() => ({}))
        throw new Error(err.detail || err.message || `HTTP ${res.status}`)
      }
      return res.json()
    },
    [apiBaseUrl, fetchFn]
  )

  // --------------------------------------------------------
  // Dropzone
  // --------------------------------------------------------

  const onDrop = useCallback((acceptedFiles: File[]) => {
    setFiles((prev) => [
      ...prev,
      ...acceptedFiles.map((file) => ({
        file,
        status: 'pending' as const,
      })),
    ])
  }, [])

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: ACCEPTED_FILE_TYPES,
  })

  const removeFile = (file: File) => {
    setFiles((prev) => prev.filter((f) => f.file !== file))
  }

  // --------------------------------------------------------
  // Step 1: Upload Files
  // --------------------------------------------------------

  /**
   * Batch upload all pending files via FormData.
   *
   * @source rag-web-ui document-upload-steps.tsx lines 137-197
   */
  const handleFileUpload = async () => {
    const pendingFiles = files.filter((f) => f.status === 'pending')
    if (pendingFiles.length === 0) return

    setIsLoading(true)
    try {
      const formData = new FormData()
      pendingFiles.forEach((fs) => formData.append('files', fs.file))

      const data: UploadResult[] = await apiFetch(
        `/knowledge-base/${knowledgeBaseId}/documents/upload`,
        { method: 'POST', body: formData }
      )

      setFiles((prev) =>
        prev.map((f) => {
          const result = data.find((d) => d.file_name === f.file.name)
          if (!result) return f

          if (result.status === 'exists') {
            return { ...f, status: 'completed', documentId: result.document_id, error: result.message }
          }
          return { ...f, status: 'uploaded', uploadId: result.upload_id, tempPath: result.temp_path }
        })
      )

      setCurrentStep(2)
    } catch (error) {
      console.error('Upload failed:', error)
    } finally {
      setIsLoading(false)
    }
  }

  // --------------------------------------------------------
  // Step 2: Preview Chunks
  // --------------------------------------------------------

  /**
   * Generate chunk preview for selected document with current settings.
   *
   * @source rag-web-ui document-upload-steps.tsx lines 200-234
   */
  const handlePreview = async () => {
    if (!selectedDocumentId) return

    setIsLoading(true)
    try {
      const data: Record<number, PreviewResponse> = await apiFetch(
        `/knowledge-base/${knowledgeBaseId}/documents/preview`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            document_ids: [selectedDocumentId],
            chunk_size: chunkSize,
            chunk_overlap: chunkOverlap,
          }),
        }
      )

      setPreviewData(data)
    } catch (error) {
      console.error('Preview failed:', error)
    } finally {
      setIsLoading(false)
    }
  }

  // --------------------------------------------------------
  // Step 3: Process Documents
  // --------------------------------------------------------

  /**
   * Start background processing (chunking + embedding) for all uploaded files.
   * Triggers polling for task completion.
   *
   * @source rag-web-ui document-upload-steps.tsx lines 237-345
   */
  const handleProcess = async () => {
    const uploadedFiles = files.filter((f) => f.status === 'uploaded')
    if (uploadedFiles.length === 0) return

    setIsLoading(true)
    try {
      const payload = uploadedFiles.map((f) => ({
        upload_id: f.uploadId!,
        file_name: f.file.name,
        status: 'pending',
        skip_processing: false,
        temp_path: f.tempPath || '',
      }))

      const data: ProcessingTaskResponse = await apiFetch(
        `/knowledge-base/${knowledgeBaseId}/documents/process`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        }
      )

      // Initialize task statuses
      const initial = data.tasks.reduce<TaskStatusMap>((acc, task) => ({
        ...acc,
        [task.task_id]: { document_id: null, status: 'pending' },
      }), {})
      setTaskStatuses(initial)

      // Update file statuses
      setFiles((prev) =>
        prev.map((f) => {
          const task = data.tasks.find((t) => t.upload_id === f.uploadId)
          return task ? { ...f, status: 'processing', taskId: task.task_id } : f
        })
      )

      // Start polling
      pollTaskStatus(data.tasks.map((t) => t.task_id))
    } catch (error) {
      setIsLoading(false)
      console.error('Processing failed:', error)
    }
  }

  /**
   * Poll backend for task completion every 2 seconds.
   *
   * @source rag-web-ui document-upload-steps.tsx lines 286-345
   */
  const pollTaskStatus = async (taskIds: number[]) => {
    const poll = async () => {
      try {
        const response: Record<string, TaskStatus> = await apiFetch(
          `/knowledge-base/${knowledgeBaseId}/documents/tasks?task_ids=${taskIds.join(',')}`
        )

        const statusMap = Object.entries(response).reduce<TaskStatusMap>(
          (acc, [key, val]) => ({ ...acc, [parseInt(key)]: val }),
          {}
        )

        setTaskStatuses(statusMap)

        // Update file statuses based on task results
        setFiles((prev) =>
          prev.map((f) => {
            if (!f.taskId || !statusMap[f.taskId]) return f
            const task = statusMap[f.taskId]
            return {
              ...f,
              status: task.status === 'completed' ? 'completed'
                    : task.status === 'failed' ? 'error'
                    : 'processing',
              documentId: task.document_id ?? f.documentId,
              error: task.error_message ?? undefined,
            }
          })
        )

        const allDone = Object.values(statusMap).every(
          (t) => t.status === 'completed' || t.status === 'failed'
        )

        if (allDone) {
          setIsLoading(false)
          const hasErrors = Object.values(statusMap).some((t) => t.status === 'failed')
          if (!hasErrors) onComplete?.()
        } else {
          setTimeout(poll, 2000)
        }
      } catch (error) {
        setIsLoading(false)
        console.error('Task status check failed:', error)
      }
    }

    poll()
  }

  // --------------------------------------------------------
  // Render
  // --------------------------------------------------------

  return (
    <div className="w-full max-w-4xl mx-auto">
      <Stepper currentStep={currentStep} />

      {/* Step 1: Upload */}
      {currentStep === 1 && (
        <Card className="p-6">
          <div className="space-y-4">
            {/* Dropzone */}
            <div
              {...getRootProps()}
              className={cn(
                'border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors',
                isDragActive
                  ? 'border-primary bg-primary/5'
                  : 'hover:border-primary/50'
              )}
            >
              <input {...getInputProps()} />
              <Upload className="w-12 h-12 mx-auto text-muted-foreground" />
              <p className="mt-2 text-sm font-medium">
                Drop your files here or click to browse
              </p>
              <p className="text-xs text-muted-foreground">
                Supports PDF, DOCX, TXT, and MD files
              </p>
            </div>

            {/* File list */}
            {files.length > 0 && (
              <div className="space-y-2 max-h-[300px] overflow-y-auto">
                {files.map((fs) => (
                  <div
                    key={fs.file.name}
                    className="flex items-center justify-between p-3 rounded-lg border"
                  >
                    <div className="flex items-center gap-3">
                      <FileText className="h-5 w-5 text-primary shrink-0" />
                      <div>
                        <p className="text-sm font-medium truncate max-w-[300px]">{fs.file.name}</p>
                        <p className="text-xs text-muted-foreground">
                          {(fs.file.size / 1024 / 1024).toFixed(2)} MB
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <StatusBadge status={fs.status} />
                      <button
                        onClick={() => removeFile(fs.file)}
                        className="p-1 hover:bg-accent rounded-full"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <Button
              onClick={handleFileUpload}
              disabled={!files.some((f) => f.status === 'pending') || isLoading}
              className="w-full"
            >
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Upload Files
            </Button>
          </div>
        </Card>
      )}

      {/* Step 2: Preview */}
      {currentStep === 2 && (
        <Card className="p-6">
          <div className="space-y-6">
            <h3 className="text-lg font-medium">Preview Document Chunks</h3>

            {/* Document selector */}
            <Select
              value={selectedDocumentId?.toString()}
              onValueChange={(v) => setSelectedDocumentId(parseInt(v))}
            >
              <SelectTrigger>
                <SelectValue placeholder="Select a document to preview" />
              </SelectTrigger>
              <SelectContent>
                {files
                  .filter((f) => f.status === 'uploaded')
                  .map((f) => (
                    <SelectItem key={f.uploadId} value={f.uploadId!.toString()}>
                      {f.file.name}
                    </SelectItem>
                  ))}
              </SelectContent>
            </Select>

            {/* Chunking settings */}
            <Accordion type="single" collapsible>
              <AccordionItem value="settings">
                <AccordionTrigger>Advanced Settings</AccordionTrigger>
                <AccordionContent>
                  <div className="grid gap-4 md:grid-cols-2 pt-4">
                    <div className="space-y-2">
                      <Label htmlFor="chunk-size">Chunk Size (tokens)</Label>
                      <Input
                        id="chunk-size"
                        type="number"
                        value={chunkSize}
                        onChange={(e) => setChunkSize(parseInt(e.target.value))}
                      />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="chunk-overlap">Chunk Overlap (tokens)</Label>
                      <Input
                        id="chunk-overlap"
                        type="number"
                        value={chunkOverlap}
                        onChange={(e) => setChunkOverlap(parseInt(e.target.value))}
                      />
                    </div>
                  </div>
                </AccordionContent>
              </AccordionItem>
            </Accordion>

            {/* Actions */}
            <div className="flex gap-4">
              <Button onClick={handlePreview} disabled={isLoading || !selectedDocumentId} className="flex-1">
                {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Preview Chunks
              </Button>
              <Button onClick={() => setCurrentStep(3)} variant="secondary" className="flex-1">
                Continue to Process
              </Button>
            </div>

            {/* Chunk preview */}
            {selectedDocumentId && previewData[selectedDocumentId] && (
              <div className="mt-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="text-sm font-medium">
                    {files.find((f) => f.uploadId === selectedDocumentId)?.file.name}
                  </h4>
                  <Badge variant="outline">
                    {previewData[selectedDocumentId].chunks.length} chunks
                  </Badge>
                </div>
                <div className="h-[400px] overflow-y-auto space-y-2 rounded-lg border p-4">
                  {previewData[selectedDocumentId].chunks.map((chunk: PreviewChunk, idx: number) => (
                    <div key={idx} className="p-3 bg-muted rounded-lg space-y-1">
                      <div className="text-xs text-muted-foreground font-medium">
                        Chunk {idx + 1}
                      </div>
                      <pre className="whitespace-pre-wrap text-sm text-foreground/80">
                        {chunk.content}
                      </pre>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </Card>
      )}

      {/* Step 3: Process */}
      {currentStep === 3 && (
        <Card className="p-6">
          <div className="space-y-4">
            <h3 className="text-lg font-medium">Process Documents</h3>

            <div className="max-h-[300px] overflow-y-auto space-y-2 rounded-lg border p-4">
              {files
                .filter((f) => f.status === 'uploaded' || f.status === 'processing' || f.status === 'completed' || f.status === 'error')
                .map((fs) => (
                  <div key={fs.uploadId ?? fs.file.name} className="p-3 border rounded-lg space-y-2">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <FileText className="h-5 w-5 text-primary shrink-0" />
                        <div>
                          <p className="text-sm font-medium">{fs.file.name}</p>
                          <p className="text-xs text-muted-foreground">
                            {(fs.file.size / 1024 / 1024).toFixed(2)} MB
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        {fs.status === 'processing' && <Loader2 className="h-4 w-4 animate-spin" />}
                        {fs.status === 'completed' && <CheckCircle className="h-5 w-5 text-green-500" />}
                        {fs.status === 'error' && <AlertCircle className="h-5 w-5 text-destructive" />}
                        <StatusBadge status={fs.status} />
                      </div>
                    </div>

                    {/* Progress bar for active processing */}
                    {fs.status === 'processing' && (
                      <Progress value={50} className="w-full" />
                    )}

                    {/* Error message */}
                    {fs.status === 'error' && fs.error && (
                      <p className="text-xs text-destructive">{fs.error}</p>
                    )}
                  </div>
                ))}
            </div>

            <Button
              onClick={handleProcess}
              disabled={isLoading || files.filter((f) => f.status === 'uploaded').length === 0}
              className="w-full"
            >
              {isLoading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Processing...
                </>
              ) : (
                <>
                  <Settings className="mr-2 h-4 w-4" />
                  Start Processing
                </>
              )}
            </Button>
          </div>
        </Card>
      )}
    </div>
  )
}

export default DocumentUploadSteps
