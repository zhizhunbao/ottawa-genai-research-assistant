/**
 * Workflow Canvas - React Flow based visual workflow editor
 *
 * @module frontend/features/workflow/workflow-canvas
 * @source dify/web/app/components/workflow/ (ReactFlow based editor)
 * @reference https://github.com/langgenius/dify
 * @template S4-M4-F4
 *
 * Visual workflow editor using React Flow:
 * 1. Drag-and-drop node placement
 * 2. Edge connections between node ports
 * 3. Node configuration via side panel
 * 4. Execution state visualization (running/completed/failed)
 * 5. Toolbar for zoom, fit, and undo/redo
 *
 * Requires: npm install reactflow
 */

import React, {
  useState,
  useCallback,
  useRef,
  type FC,
  type DragEvent,
} from "react";

// â”€â”€â”€ Types (matches workflow-engine.py.template) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export type NodeType =
  | "start"
  | "end"
  | "llm"
  | "code"
  | "condition"
  | "http_request"
  | "tool"
  | "template"
  | "parallel";

export type NodeStatus =
  | "pending"
  | "running"
  | "completed"
  | "failed"
  | "skipped";

export interface WorkflowNode {
  id: string;
  type: NodeType;
  title: string;
  params: Record<string, unknown>;
  position: { x: number; y: number };
  status?: NodeStatus;
}

export interface WorkflowEdge {
  id: string;
  source: string;
  target: string;
  label?: string; // "true" | "false" for condition nodes
}

export interface WorkflowData {
  nodes: WorkflowNode[];
  edges: WorkflowEdge[];
}

// â”€â”€â”€ Node Type Definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface NodeTypeConfig {
  type: NodeType;
  label: string;
  icon: string;
  color: string;
  description: string;
}

export const NODE_TYPES: NodeTypeConfig[] = [
  { type: "start", label: "Start", icon: "â–¶", color: "#10b981", description: "Workflow entry point" },
  { type: "end", label: "End", icon: "â¹", color: "#ef4444", description: "Workflow exit point" },
  { type: "llm", label: "LLM", icon: "ğŸ¤–", color: "#8b5cf6", description: "Language model call" },
  { type: "code", label: "Code", icon: "ğŸ’»", color: "#3b82f6", description: "Execute code" },
  { type: "condition", label: "If/Else", icon: "ğŸ”€", color: "#f59e0b", description: "Conditional branch" },
  { type: "http_request", label: "HTTP", icon: "ğŸŒ", color: "#06b6d4", description: "HTTP request" },
  { type: "tool", label: "Tool", icon: "ğŸ”§", color: "#ec4899", description: "Tool execution" },
  { type: "template", label: "Template", icon: "ğŸ“", color: "#84cc16", description: "Text template" },
];

const STATUS_COLORS: Record<NodeStatus, string> = {
  pending: "#94a3b8",
  running: "#3b82f6",
  completed: "#10b981",
  failed: "#ef4444",
  skipped: "#9ca3af",
};

// â”€â”€â”€ Styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const styles = {
  container: {
    display: "flex",
    height: "100%",
    width: "100%",
    background: "var(--bg-canvas, #f1f5f9)",
    fontFamily: "var(--font-sans, system-ui, sans-serif)",
  } as React.CSSProperties,

  sidebar: {
    width: "240px",
    background: "var(--card-bg, #ffffff)",
    borderRight: "1px solid var(--border-color, #e2e8f0)",
    padding: "16px",
    overflowY: "auto" as const,
  } as React.CSSProperties,

  sidebarTitle: {
    fontSize: "var(--text-sm, 14px)",
    fontWeight: 600,
    color: "var(--text-primary, #1e293b)",
    textTransform: "uppercase" as const,
    letterSpacing: "0.05em",
    marginBottom: "12px",
  } as React.CSSProperties,

  nodeCard: {
    display: "flex",
    alignItems: "center",
    gap: "8px",
    padding: "10px 12px",
    marginBottom: "6px",
    borderRadius: "var(--radius-sm, 8px)",
    border: "1px solid var(--border-color, #e2e8f0)",
    background: "var(--card-bg, #ffffff)",
    cursor: "grab",
    fontSize: "var(--text-sm, 14px)",
    transition: "box-shadow 0.15s ease",
  } as React.CSSProperties,

  canvas: {
    flex: 1,
    position: "relative" as const,
    overflow: "hidden",
  } as React.CSSProperties,

  canvasInner: {
    width: "100%",
    height: "100%",
    position: "relative" as const,
  } as React.CSSProperties,

  workflowNode: {
    position: "absolute" as const,
    minWidth: "180px",
    background: "var(--card-bg, #ffffff)",
    borderRadius: "var(--radius-md, 10px)",
    boxShadow: "0 2px 8px rgba(0,0,0,0.08)",
    border: "2px solid var(--border-color, #e2e8f0)",
    cursor: "move",
    userSelect: "none" as const,
  } as React.CSSProperties,

  nodeHeader: {
    display: "flex",
    alignItems: "center",
    gap: "8px",
    padding: "10px 14px",
    borderBottom: "1px solid var(--border-color, #e2e8f0)",
    fontSize: "var(--text-sm, 14px)",
    fontWeight: 600,
  } as React.CSSProperties,

  nodeBody: {
    padding: "8px 14px",
    fontSize: "var(--text-xs, 12px)",
    color: "var(--text-secondary, #64748b)",
  } as React.CSSProperties,

  nodeIcon: {
    fontSize: "16px",
  } as React.CSSProperties,

  statusDot: {
    width: "8px",
    height: "8px",
    borderRadius: "50%",
    marginLeft: "auto",
  } as React.CSSProperties,

  toolbar: {
    position: "absolute" as const,
    bottom: "16px",
    left: "50%",
    transform: "translateX(-50%)",
    display: "flex",
    gap: "4px",
    padding: "6px",
    background: "var(--card-bg, #ffffff)",
    borderRadius: "var(--radius-md, 10px)",
    boxShadow: "0 2px 12px rgba(0,0,0,0.1)",
    border: "1px solid var(--border-color, #e2e8f0)",
  } as React.CSSProperties,

  toolbarBtn: {
    padding: "6px 12px",
    fontSize: "var(--text-sm, 14px)",
    border: "none",
    borderRadius: "var(--radius-sm, 6px)",
    background: "transparent",
    cursor: "pointer",
    color: "var(--text-primary, #1e293b)",
    transition: "background 0.15s ease",
  } as React.CSSProperties,

  emptyState: {
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    height: "100%",
    color: "var(--text-secondary, #94a3b8)",
    fontSize: "var(--text-lg, 18px)",
  } as React.CSSProperties,
};

// â”€â”€â”€ Workflow Node Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface WorkflowNodeCardProps {
  node: WorkflowNode;
  isSelected: boolean;
  onClick: () => void;
}

const WorkflowNodeCard: FC<WorkflowNodeCardProps> = ({ node, isSelected, onClick }) => {
  const typeConfig = NODE_TYPES.find((t) => t.type === node.type);
  const statusColor = node.status ? STATUS_COLORS[node.status] : undefined;

  return (
    <div
      style={{
        ...styles.workflowNode,
        left: node.position.x,
        top: node.position.y,
        borderColor: isSelected
          ? "var(--color-brand, #4318ff)"
          : typeConfig?.color ?? "var(--border-color)",
      }}
      onClick={onClick}
    >
      <div style={styles.nodeHeader}>
        <span style={styles.nodeIcon}>{typeConfig?.icon ?? "?"}</span>
        <span>{node.title || typeConfig?.label}</span>
        {statusColor && (
          <span style={{ ...styles.statusDot, background: statusColor }} />
        )}
      </div>
      <div style={styles.nodeBody}>
        {typeConfig?.description}
      </div>
    </div>
  );
};

// â”€â”€â”€ Workflow Canvas Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// @source dify/web/app/components/workflow/ â†’ simplified

export interface WorkflowCanvasProps {
  data: WorkflowData;
  onChange: (data: WorkflowData) => void;
  onNodeSelect?: (nodeId: string | null) => void;
  className?: string;
}

export const WorkflowCanvas: FC<WorkflowCanvasProps> = ({
  data,
  onChange,
  onNodeSelect,
  className,
}) => {
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);
  const canvasRef = useRef<HTMLDivElement>(null);

  const handleNodeClick = useCallback(
    (nodeId: string) => {
      setSelectedNodeId(nodeId);
      onNodeSelect?.(nodeId);
    },
    [onNodeSelect]
  );

  const handleDragOver = useCallback((e: DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "copy";
  }, []);

  const handleDrop = useCallback(
    (e: DragEvent) => {
      e.preventDefault();
      const type = e.dataTransfer.getData("workflow/node-type") as NodeType;
      if (!type) return;

      const rect = canvasRef.current?.getBoundingClientRect();
      if (!rect) return;

      const position = {
        x: e.clientX - rect.left - 90,
        y: e.clientY - rect.top - 30,
      };

      const typeConfig = NODE_TYPES.find((t) => t.type === type);
      const newNode: WorkflowNode = {
        id: `node_${Date.now()}`,
        type,
        title: typeConfig?.label ?? type,
        params: {},
        position,
      };

      onChange({
        ...data,
        nodes: [...data.nodes, newNode],
      });
    },
    [data, onChange]
  );

  const handleDeleteSelected = useCallback(() => {
    if (!selectedNodeId) return;
    onChange({
      nodes: data.nodes.filter((n) => n.id !== selectedNodeId),
      edges: data.edges.filter(
        (e) => e.source !== selectedNodeId && e.target !== selectedNodeId
      ),
    });
    setSelectedNodeId(null);
    onNodeSelect?.(null);
  }, [selectedNodeId, data, onChange, onNodeSelect]);

  return (
    <div style={styles.container} className={className}>
      {/* Sidebar â€” Node Palette */}
      <div style={styles.sidebar}>
        <h3 style={styles.sidebarTitle}>Nodes</h3>
        {NODE_TYPES.map((nt) => (
          <div
            key={nt.type}
            style={styles.nodeCard}
            draggable
            onDragStart={(e) => {
              e.dataTransfer.setData("workflow/node-type", nt.type);
              e.dataTransfer.effectAllowed = "copy";
            }}
          >
            <span style={styles.nodeIcon}>{nt.icon}</span>
            <span>{nt.label}</span>
          </div>
        ))}
      </div>

      {/* Canvas */}
      <div
        ref={canvasRef}
        style={styles.canvas}
        onDragOver={handleDragOver}
        onDrop={handleDrop}
        onClick={() => {
          setSelectedNodeId(null);
          onNodeSelect?.(null);
        }}
      >
        <div style={styles.canvasInner}>
          {data.nodes.length === 0 ? (
            <div style={styles.emptyState}>
              Drag nodes from the sidebar to build your workflow
            </div>
          ) : (
            data.nodes.map((node) => (
              <WorkflowNodeCard
                key={node.id}
                node={node}
                isSelected={selectedNodeId === node.id}
                onClick={() => handleNodeClick(node.id)}
              />
            ))
          )}
        </div>

        {/* Toolbar */}
        <div style={styles.toolbar}>
          <button
            style={styles.toolbarBtn}
            onClick={handleDeleteSelected}
            disabled={!selectedNodeId}
            title="Delete selected node"
          >
            ğŸ—‘ï¸ Delete
          </button>
          <button
            style={styles.toolbarBtn}
            onClick={() => onChange({ nodes: [], edges: [] })}
            title="Clear all"
          >
            ğŸ§¹ Clear
          </button>
        </div>
      </div>
    </div>
  );
};

export default WorkflowCanvas;
