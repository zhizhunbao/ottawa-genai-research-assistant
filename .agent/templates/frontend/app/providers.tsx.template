/**
 * AppProvider - Global application provider composition
 *
 * @module app/providers
 * @source bulletproof-react/apps/react-vite/src/app/provider.tsx (53L)
 * @reference https://github.com/alan2207/bulletproof-react
 * @template S2-M2-F1
 *
 * Composes all global providers in the correct nesting order:
 * 1. React.Suspense (loading fallback for lazy-loaded routes)
 * 2. ErrorBoundary (catch unhandled errors)
 * 3. HelmetProvider (SEO head management) — optional
 * 4. QueryClientProvider (data fetching with React Query)
 * 5. ThemeProvider (dark/light mode) — optional
 * 6. Notifications (toast notifications)
 * 7. AuthLoader (authentication gate) — optional
 *
 * Provider nesting order matters:
 * - Router > Auth > Query > Theme > UI > children
 *
 * Usage:
 * ```tsx
 * // In your app entry point (main.tsx or App.tsx)
 * import { AppProvider } from './providers';
 * import { AppRouter } from './router';
 *
 * function App() {
 *   return (
 *     <AppProvider>
 *       <AppRouter />
 *     </AppProvider>
 *   );
 * }
 * ```
 */

import * as React from "react";

// ─── Types ───────────────────────────────────────────────────────────────────

export interface AppProviderProps {
  children: React.ReactNode;
}

// ─── Configuration ───────────────────────────────────────────────────────────

/**
 * React Query default options.
 * @source bulletproof-react/apps/react-vite/src/lib/react-query.ts (27L)
 */
const queryConfig = {
  queries: {
    refetchOnWindowFocus: false,
    retry: false,
    staleTime: 1000 * 60, // 1 minute
  },
};

// ─── Error Fallback ──────────────────────────────────────────────────────────

/**
 * Main error fallback UI for uncaught errors.
 * @source bulletproof-react/apps/react-vite/src/components/errors/main.tsx (19L)
 */
const MainErrorFallback: React.FC<{ error: Error; resetErrorBoundary: () => void }> = ({
  error,
  resetErrorBoundary,
}) => {
  return (
    <div
      className="flex h-screen w-screen flex-col items-center justify-center gap-4"
      role="alert"
    >
      {/* Error icon */}
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="48"
        height="48"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        className="text-[var(--color-destructive)]"
      >
        <circle cx="12" cy="12" r="10" />
        <path d="m15 9-6 6" />
        <path d="m9 9 6 6" />
      </svg>

      <h2 className="text-xl font-semibold text-[var(--color-destructive)]">
        Something went wrong
      </h2>

      <p className="max-w-md text-center text-sm text-[var(--color-muted-foreground)]">
        {error.message || "An unexpected error occurred."}
      </p>

      <button
        className="mt-2 rounded-md bg-[var(--color-primary)] px-4 py-2 text-sm font-medium text-[var(--color-primary-foreground)] hover:bg-[var(--color-primary)]/90 transition-colors"
        onClick={resetErrorBoundary}
      >
        Try Again
      </button>
    </div>
  );
};

// ─── Loading Fallback ────────────────────────────────────────────────────────

const LoadingFallback: React.FC = () => (
  <div className="flex h-screen w-screen items-center justify-center">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      className="h-12 w-12 animate-spin text-[var(--color-foreground)]"
    >
      <path d="M21 12a9 9 0 1 1-6.219-8.56" />
    </svg>
  </div>
);

// ─── Simple ErrorBoundary ────────────────────────────────────────────────────

interface ErrorBoundaryProps {
  FallbackComponent: React.ComponentType<{
    error: Error;
    resetErrorBoundary: () => void;
  }>;
  children: React.ReactNode;
}

interface ErrorBoundaryState {
  hasError: boolean;
  error: Error | null;
}

class ErrorBoundary extends React.Component<
  ErrorBoundaryProps,
  ErrorBoundaryState
> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error("[AppProvider] Uncaught error:", error, errorInfo);
  }

  resetErrorBoundary = () => {
    this.setState({ hasError: false, error: null });
  };

  render() {
    if (this.state.hasError && this.state.error) {
      const { FallbackComponent } = this.props;
      return (
        <FallbackComponent
          error={this.state.error}
          resetErrorBoundary={this.resetErrorBoundary}
        />
      );
    }
    return this.props.children;
  }
}

// ─── AppProvider Component ───────────────────────────────────────────────────

/**
 * Root application provider.
 *
 * Nesting order (outermost → innermost):
 *   Suspense → ErrorBoundary → QueryClient → Notifications → Auth → children
 *
 * To customize:
 * 1. Import your actual providers (react-query, auth, theme, etc.)
 * 2. Replace the placeholders below with real implementations
 * 3. Add new providers by wrapping children at the appropriate level
 */
export const AppProvider: React.FC<AppProviderProps> = ({ children }) => {
  // React Query client (stable reference via useState)
  // Replace with: const [queryClient] = React.useState(() => new QueryClient({ defaultOptions: queryConfig }));
  const _queryConfig = queryConfig; // Reference to avoid lint warning

  return (
    <React.Suspense fallback={<LoadingFallback />}>
      <ErrorBoundary FallbackComponent={MainErrorFallback}>
        {/* 
          TODO: Add your providers here in this order:
          
          <HelmetProvider>
            <QueryClientProvider client={queryClient}>
              {import.meta.env.DEV && <ReactQueryDevtools />}
              <ThemeProvider defaultTheme="system" storageKey="app-theme">
                <Notifications />
                <AuthLoader renderLoading={() => <LoadingFallback />}>
                  {children}
                </AuthLoader>
              </ThemeProvider>
            </QueryClientProvider>
          </HelmetProvider>
        */}
        {children}
      </ErrorBoundary>
    </React.Suspense>
  );
};

AppProvider.displayName = "AppProvider";

export { ErrorBoundary, MainErrorFallback, LoadingFallback, queryConfig };
export default AppProvider;
