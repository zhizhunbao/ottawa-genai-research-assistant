# Phase 2 PRD: 核心 RAG 功能

**Phase**: 2 of 3  
**时间**: 4 周  
**状态**: 🔄 进行中 (US-202~205 ✅ Done, Chat UX 🔴 剩余)  
**前置**: Phase 1 完成  
**术语规范**: 参见 `dev-terminology`

---

## 目标

实现端到端的 RAG（检索增强生成）功能，包括自动文档管道、智能检索和引用生成。

---

## 用户故事

### US-201: 自动文档管道

**作为** 系统管理员，  
**我想要** 文档从经济门户自动同步到 RAG 系统，  
**以便** 无需手动上传即可保持数据最新。

**验收标准**:

- [ ] 文档存储到 Azure Blob Storage / Microsoft Fabric
- [ ] 门户新增文档时自动触发处理管道
- [ ] 管道执行：分块 → 嵌入生成 → 索引到 Azure AI Search
- [ ] RAG Pipeline Mapping 从 Azure Portal 配置
- [ ] 支持查看处理状态（Pending → Processing → Indexed）

### US-202: 自然语言查询

**作为** 经济发展分析师，  
**我想要** 使用自然语言提问，  
**以便** 快速获取相关的季度报告数据。

**验收标准**:

- [ ] 用户输入自然语言后，系统在 3s 内返回结果
- [ ] 检索使用 Top-5 混合搜索（Cosine + BM25）
- [ ] 结果按相关性排序
- [ ] 支持英语和法语查询

### US-203: 带引用的回答生成

**作为** 经济发展分析师，  
**我想要** 回答包含具体来源引用，  
**以便** 验证答案可信度。

**验收标准**:

- [ ] 每个回答包含至少一个来源引用
- [ ] 引用格式：[文档名, 页码, 原文摘要]
- [ ] 显示置信度指标（高/中/低）
- [ ] 点击引用可跳转到原文预览
- [ ] 无法找到内容时显示"未找到相关信息"

### US-204: 聊天历史持久化

**作为** 经济发展分析师，  
**我想要** 聊天历史被保存，  
**以便** 下次登录继续之前对话。

**验收标准**:

- [ ] 聊天历史按用户存储到 Cosmos DB
- [ ] 支持查看历史对话列表
- [ ] 支持删除历史记录
- [ ] 支持继续历史对话

### US-205: 双语支持

**作为** 经济发展分析师，  
**我想要** 切换英语和法语界面，  
**以便** 与法语用户分享结果。

**验收标准**:

- [ ] 界面支持一键切换英语/法语
- [ ] 所有 UI 文案通过 i18n 管理
- [ ] 查询和回答支持双语处理
- [ ] 语言偏好持久化存储

---

## 技术任务

| 任务                  | 优先级 | 依赖                   |
| --------------------- | ------ | ---------------------- |
| RAG Orchestrator 实现 | P0     | Phase 1                |
| 文档处理管道          | P0     | Azure Blob + AI Search |
| 混合搜索实现          | P0     | AI Search 配置         |
| 引用提取和格式化      | P0     | RAG Orchestrator       |
| Cosmos DB 集成        | P1     | 无                     |
| Prompt 优化           | P1     | RAG 基础功能           |
| i18n 框架集成         | P1     | 无                     |
| 翻译文件创建          | P2     | i18n 框架              |

---

## RAG 配置规格

| 参数           | 规格                         |
| -------------- | ---------------------------- |
| Embedding 模型 | text-embedding-ada-002       |
| 生成模型       | GPT-4o (Azure AI Foundry)    |
| 检索策略       | 混合搜索（Vector + Keyword） |
| Top-K          | 5 chunks                     |
| 排名算法       | Cosine Similarity + BM25     |
| 回退策略       | 无匹配时返回"未找到相关信息" |
| 引用格式       | [文档名, 页码, 摘要]         |
| 置信度阈值     | 低于 0.5 显示低置信度警告    |

---

## 成功标准

- [ ] 文档自动从门户同步并索引
- [ ] 用户可自然语言查询并获得带引用的回答
- [ ] 聊天历史持久化到 Cosmos DB
- [ ] 界面支持英法双语切换

---

## 风险与缓解

| 风险           | 缓解措施                      |
| -------------- | ----------------------------- |
| RAG 质量不稳定 | Prompt 迭代优化               |
| 管道触发延迟   | 使用 Azure Functions 事件触发 |
| 双语翻译质量   | 使用专业翻译服务校对          |

---

_Phase 2 of Ottawa GenAI Research Assistant. See [master_prd.md](master_prd.md) for overview._
