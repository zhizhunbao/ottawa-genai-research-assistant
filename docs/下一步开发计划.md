# Ottawa GenAI Research Assistant - 下一步开发计划

**生成日期**: 2025年11月18日  
**基于文档**: [项目现状文档](项目现状文档.md)  
**计划版本**: 1.0  
**预计完成时间**: 2026年1月（8周后）

---

## 📋 执行摘要

本文档基于项目现状分析，制定了详细的开发计划，旨在完成Phase 1的核心功能，特别是实现RAG（检索增强生成）功能，使系统能够基于上传的PDF文档进行智能问答。

### 核心目标

1. **实现完整的RAG功能** - 使聊天功能能够基于上传文档进行问答
2. **集成向量数据库** - 实现文档的语义搜索和检索
3. **重建测试套件** - 确保代码质量和系统稳定性
4. **增强报告生成** - 基于实际文档内容生成报告

### 时间线概览

- **Sprint 1 (2周)**: 向量数据库集成 + 真实Embedding实现
- **Sprint 2 (2周)**: RAG功能实现 + 聊天服务集成
- **Sprint 3 (2周)**: 测试套件重建 + 文档处理增强
- **Sprint 4 (2周)**: 报告生成增强 + 数据可视化
- **总计**: 8周（2个月）

---

## 🎯 开发优先级

### P0 - 关键路径（必须完成）

1. **向量数据库集成** - RAG功能的基础
2. **真实Embedding实现** - 替换当前的hash-based方法
3. **RAG检索功能** - 在聊天服务中集成文档检索
4. **基础测试套件** - 确保代码质量

### P1 - 重要功能（高优先级）

5. **文档元数据增强** - 季度、主题标签等
6. **报告生成改进** - 基于实际文档内容
7. **数据可视化** - 图表和表格生成

### P2 - 优化功能（中优先级）

8. **性能优化** - 缓存、异步处理
9. **用户体验改进** - UI/UX优化
10. **文档格式支持** - 支持更多文档类型

---

## 📅 详细开发计划

## Sprint 1: 向量数据库集成 + 真实Embedding实现

**时间**: 第1-2周  
**目标**: 完成向量数据库集成，实现真实的文档嵌入和存储

### 任务 1.1: 选择并集成向量数据库

**优先级**: P0  
**预计时间**: 3天  
**负责人**: 后端开发

**任务描述**:
- 评估向量数据库选项（ChromaDB vs Qdrant vs FAISS）
- 选择ChromaDB（已在requirements.txt中，轻量级，易于集成）
- 实现ChromaDB客户端封装
- 配置持久化存储路径

**技术细节**:
```python
# 需要创建的新文件
backend/app/services/vector_store.py
backend/app/core/vector_config.py
```

**验收标准**:
- [x] ChromaDB成功初始化和连接
- [x] 可以创建集合（collection）
- [x] 可以存储和检索向量
- [x] 持久化存储正常工作

**状态**: ✅ 已完成（2025-11-18）
- VectorStore类已实现（`backend/app/services/vector_store.py`）
- VectorConfig配置类已实现（`backend/app/core/vector_config.py`）
- 持久化存储路径：`monk/vector_db`
- 已通过测试验证

**依赖**: 无

---

### 任务 1.2: 实现真实Embedding生成

**优先级**: P0  
**预计时间**: 4天  
**负责人**: 后端开发

**任务描述**:
- 替换当前的hash-based embedding方法
- 集成sentence-transformers库（免费，本地运行）
- 或使用Google Gemini Embedding API（如果可用）
- 实现批量embedding生成

**技术选择**:
- **推荐**: sentence-transformers (all-MiniLM-L6-v2) - 免费，384维
- **备选**: Google Gemini Embedding API

**代码变更**:
```python
# 修改文件
backend/app/services/document_service.py
  - _generate_embeddings() 方法需要重写

# 新增依赖
backend/requirements.txt
  + sentence-transformers>=2.2.0
```

**验收标准**:
- [ ] 能够为文本块生成真实的语义embedding
- [ ] Embedding维度为384（与ChromaDB兼容）
- [ ] 相似文本的embedding相似度较高
- [ ] 批量处理性能可接受（>100 chunks/分钟）

**依赖**: 任务1.1

---

### 任务 1.3: 实现文档分块和向量存储

**优先级**: P0  
**预计时间**: 3天  
**负责人**: 后端开发

**任务描述**:
- 改进文档分块策略（当前已实现，需要优化）
- 实现文档chunk到向量数据库的存储
- 实现向量ID与文档的关联
- 更新文档处理流程

**代码变更**:
```python
# 修改文件
backend/app/services/document_service.py
  - process_document() - 添加向量存储调用
  - _store_in_vector_db() - 实现真实存储
  - _chunk_text() - 优化分块策略

# 新增文件
backend/app/services/vector_store.py
  - VectorStore类
  - add_documents()方法
  - search()方法
```

**验收标准**:
- [x] 文档上传后自动分块并存储到向量数据库（VectorStore已实现）
- [x] 每个chunk都有对应的向量ID（add_documents方法已实现）
- [ ] 文档模型中的vector_id字段正确更新（待集成到document_service）
- [x] 可以查询到已存储的文档chunks（get_by_ids方法已实现）

**状态**: 🟡 部分完成（2025-11-18）
- VectorStore类已实现所有核心方法
- 需要集成到document_service的文档处理流程

**依赖**: 任务1.1 ✅, 1.2

---

### 任务 1.4: 实现语义搜索功能

**优先级**: P0  
**预计时间**: 3天  
**负责人**: 后端开发

**任务描述**:
- 实现基于向量数据库的语义搜索
- 支持相似度阈值过滤
- 返回相关文档chunks和元数据
- 实现混合搜索（语义 + 关键词，可选）

**代码变更**:
```python
# 修改文件
backend/app/services/document_service.py
  - search_documents() - 使用向量数据库搜索

# 新增文件
backend/app/services/vector_store.py
  - search_similar()方法
  - get_by_ids()方法
```

**验收标准**:
- [x] 可以基于查询文本进行语义搜索（search方法已实现）
- [x] 返回结果按相似度排序（ChromaDB自动排序）
- [x] 结果包含文档ID、chunk文本、相似度分数（已格式化返回）
- [ ] 搜索响应时间 < 500ms（P95）（待性能测试）

**状态**: 🟡 部分完成（2025-11-18）
- VectorStore.search()方法已实现
- 需要集成到document_service的search_documents方法

**依赖**: 任务1.1 ✅, 1.2, 1.3 🟡

---

### Sprint 1 交付物

- ✅ 向量数据库集成完成（2025-11-18）
- ⏳ 真实Embedding生成实现（待完成）
- 🟡 文档向量存储功能（VectorStore已实现，待集成）
- 🟡 语义搜索功能（VectorStore已实现，待集成）

---

## Sprint 2: RAG功能实现 + 聊天服务集成

**时间**: 第3-4周  
**目标**: 在聊天功能中集成RAG，实现基于文档的智能问答

### 任务 2.1: 实现RAG检索服务

**优先级**: P0  
**预计时间**: 4天  
**负责人**: 后端开发

**任务描述**:
- 创建RAG服务层，封装检索逻辑
- 实现查询重写（query rewriting）以提高检索质量
- 实现上下文窗口管理（选择最相关的chunks）
- 支持多文档检索

**代码变更**:
```python
# 新增文件
backend/app/services/rag_service.py
  - RAGService类
  - retrieve_context()方法
  - format_context()方法
```

**验收标准**:
- [ ] 可以根据用户查询检索相关文档chunks
- [ ] 返回的chunks数量可配置（默认3-5个）
- [ ] 支持按文档、日期、主题过滤
- [ ] 检索结果包含源文档信息

**依赖**: Sprint 1完成

---

### 任务 2.2: 集成RAG到聊天服务

**优先级**: P0  
**预计时间**: 5天  
**负责人**: 后端开发

**任务描述**:
- 修改聊天服务，在生成回答前先检索相关文档
- 将检索到的上下文注入到AI提示词中
- 实现源引用功能（在回答中标注来源）
- 支持RAG模式和普通模式的切换

**代码变更**:
```python
# 修改文件
backend/app/services/chat_service.py
  - generate_response() - 添加RAG检索
  - _build_rag_prompt() - 构建包含上下文的提示词

# 修改文件
backend/app/api/chat.py
  - 添加use_rag参数（可选）
```

**验收标准**:
- [ ] 聊天时可以基于上传的文档回答问题
- [ ] 回答中包含源文档引用
- [ ] 回答质量明显提升（基于文档内容）
- [ ] 支持RAG开关（用户可选择是否使用RAG）

**依赖**: 任务2.1

---

### 任务 2.3: 实现源引用和信任指标

**优先级**: P1  
**预计时间**: 3天  
**负责人**: 后端开发

**任务描述**:
- 在回答中标注来源文档和页码
- 实现相似度分数显示（作为置信度指标）
- 在前端显示源引用链接
- 实现基本的信任度评分

**代码变更**:
```python
# 修改文件
backend/app/models/chat.py
  - MessageMetadata - 添加sources字段

# 修改文件
frontend/src/pages/ChatPage.tsx
  - 显示源引用
  - 显示置信度分数
```

**验收标准**:
- [ ] 每个回答都包含源文档引用
- [ ] 前端正确显示源引用链接
- [ ] 置信度分数可见
- [ ] 用户可以点击查看源文档

**依赖**: 任务2.2

---

### 任务 2.4: 优化提示词工程

**优先级**: P1  
**预计时间**: 2天  
**负责人**: 后端开发 + AI工程师

**任务描述**:
- 优化RAG提示词模板
- 实现多语言提示词支持
- 添加指令：基于上下文回答，不知道时明确说明
- A/B测试不同提示词效果

**代码变更**:
```python
# 修改文件
backend/app/services/chat_service.py
  - _build_rag_prompt() - 优化提示词
```

**验收标准**:
- [ ] 提示词模板清晰明确
- [ ] 支持英语、法语、中文
- [ ] AI能够正确使用上下文
- [ ] 回答质量达到预期（≥75%准确率）

**依赖**: 任务2.2

---

### Sprint 2 交付物

- ✅ RAG检索服务实现
- ✅ 聊天服务集成RAG
- ✅ 源引用功能
- ✅ 基于文档的智能问答可用

---

## Sprint 3: 测试套件重建 + 文档处理增强

**时间**: 第5-6周  
**目标**: 重建测试覆盖，增强文档处理能力

### 任务 3.1: 重建单元测试

**优先级**: P0  
**预计时间**: 5天  
**负责人**: 全栈开发

**任务描述**:
- 为所有服务层创建单元测试
- 为Repository层创建测试
- 为API端点创建测试
- 配置pytest和测试覆盖率工具

**代码变更**:
```python
# 新增目录结构
backend/tests/
  ├── unit/
  │   ├── services/
  │   │   ├── test_document_service.py
  │   │   ├── test_chat_service.py
  │   │   ├── test_rag_service.py
  │   │   └── test_vector_store.py
  │   ├── repositories/
  │   │   └── test_*.py
  │   └── conftest.py
  ├── integration/
  │   ├── test_api_integration.py
  │   └── conftest.py
  └── pytest.ini
```

**验收标准**:
- [ ] 单元测试覆盖率 > 70%
- [ ] 所有关键服务都有测试
- [ ] 测试可以独立运行
- [ ] CI/CD集成测试运行

**依赖**: 无

---

### 任务 3.2: 重建集成测试

**优先级**: P0  
**预计时间**: 3天  
**负责人**: 全栈开发

**任务描述**:
- 创建端到端集成测试
- 测试完整的工作流：上传文档 → 处理 → 搜索 → 问答
- 测试API端点集成
- 配置测试数据库/存储

**验收标准**:
- [ ] 关键工作流有集成测试
- [ ] 测试可以自动化运行
- [ ] 测试覆盖主要用户场景

**依赖**: 任务3.1

---

### 任务 3.3: 实现文档元数据增强

**优先级**: P1  
**预计时间**: 4天  
**负责人**: 后端开发

**任务描述**:
- 从PDF文件名/内容中提取季度信息（Q1 2024等）
- 实现主题标签自动分类
- 提取关键指标和统计数据
- 增强文档元数据模型

**代码变更**:
```python
# 修改文件
backend/app/services/document_service.py
  - _extract_metadata() - 增强元数据提取
  - _extract_quarter() - 提取季度
  - _classify_topics() - 主题分类

# 修改文件
backend/app/models/document.py
  - DocumentMetadata - 添加quarter, topics字段
```

**验收标准**:
- [ ] 能够自动识别文档季度
- [ ] 能够提取主题标签
- [ ] 元数据正确存储
- [ ] 可以按季度、主题过滤文档

**依赖**: 无

---

### 任务 3.4: 改进文档分块策略

**优先级**: P1  
**预计时间**: 3天  
**负责人**: 后端开发

**任务描述**:
- 实现智能分块（基于段落、章节）
- 保留上下文信息（前后文）
- 优化chunk大小（当前1000字符，可调整）
- 实现重叠策略优化

**代码变更**:
```python
# 修改文件
backend/app/services/document_service.py
  - _chunk_text() - 改进分块逻辑
```

**验收标准**:
- [ ] 分块更符合语义边界
- [ ] 重要信息不被分割
- [ ] 分块大小可配置
- [ ] 检索质量提升

**依赖**: 无

---

### Sprint 3 交付物

- ✅ 测试套件重建完成
- ✅ 文档元数据增强
- ✅ 文档分块策略优化
- ✅ 测试覆盖率达标

---

## Sprint 4: 报告生成增强 + 数据可视化

**时间**: 第7-8周  
**目标**: 实现基于文档的报告生成和数据可视化

### 任务 4.1: 实现基于文档的报告生成

**优先级**: P1  
**预计时间**: 5天  
**负责人**: 后端开发

**任务描述**:
- 修改报告生成服务，使用RAG检索相关文档
- 基于检索到的文档内容生成报告
- 实现报告模板系统
- 支持多种报告格式（HTML, PDF, Word）

**代码变更**:
```python
# 修改文件
backend/app/services/report_service.py
  - generate_report() - 集成RAG检索
  - _build_report_content() - 基于文档内容生成

# 新增文件
backend/app/templates/
  - report_template.html
  - report_template_word.docx
```

**验收标准**:
- [ ] 报告基于实际文档内容生成
- [ ] 报告包含源文档引用
- [ ] 支持多种格式导出
- [ ] 报告质量达到预期

**依赖**: Sprint 2完成

---

### 任务 4.2: 实现数据可视化

**优先级**: P1  
**预计时间**: 5天  
**负责人**: 后端开发

**任务描述**:
- 从文档中提取结构化数据（表格、数字）
- 使用Plotly生成图表（柱状图、折线图、饼图等）
- 实现自动图表类型选择
- 在报告中嵌入图表

**技术选择**:
- **图表库**: Plotly (支持多种格式，易于集成)
- **数据处理**: pandas, numpy

**代码变更**:
```python
# 新增文件
backend/app/services/visualization_service.py
  - VisualizationService类
  - extract_data()方法
  - generate_chart()方法

# 新增依赖
backend/requirements.txt
  + plotly>=5.0.0
  + pandas>=2.0.0
```

**验收标准**:
- [ ] 能够从文档中提取数据
- [ ] 能够生成常见图表类型
- [ ] 图表可以嵌入到报告中
- [ ] 图表准确反映数据

**依赖**: 任务4.1

---

### 任务 4.3: 实现报告模板系统

**优先级**: P1  
**预计时间**: 3天  
**负责人**: 后端开发

**任务描述**:
- 创建可配置的报告模板
- 支持自定义模板
- 实现模板变量替换
- 支持多语言模板

**代码变更**:
```python
# 新增文件
backend/app/services/template_service.py
  - TemplateService类
  - render_template()方法

# 新增目录
backend/app/templates/
  - reports/
    - default.html
    - executive_summary.html
    - detailed_analysis.html
```

**验收标准**:
- [ ] 支持多种报告模板
- [ ] 模板变量正确替换
- [ ] 支持自定义模板
- [ ] 模板系统易于扩展

**依赖**: 任务4.1

---

### 任务 4.4: 前端报告展示优化

**优先级**: P2  
**预计时间**: 2天  
**负责人**: 前端开发

**任务描述**:
- 优化报告页面UI
- 实现报告预览功能
- 添加图表交互功能
- 实现报告下载优化

**代码变更**:
```python
# 修改文件
frontend/src/pages/ReportPage.tsx
  - 优化UI布局
  - 添加图表展示
  - 实现预览功能
```

**验收标准**:
- [ ] 报告页面UI美观
- [ ] 图表正确显示
- [ ] 预览功能正常
- [ ] 下载功能正常

**依赖**: 任务4.1, 4.2

---

### Sprint 4 交付物

- ✅ 基于文档的报告生成
- ✅ 数据可视化功能
- ✅ 报告模板系统
- ✅ 前端报告展示优化

---

## 🔧 技术债务和优化任务

### 任务 5.1: 性能优化

**优先级**: P2  
**预计时间**: 3天  
**负责人**: 后端开发

**任务描述**:
- 实现缓存机制（Redis或内存缓存）
- 优化文档处理性能（异步处理）
- 实现批量操作优化
- 添加性能监控

**验收标准**:
- [ ] 响应时间提升 > 30%
- [ ] 支持并发用户 > 50
- [ ] 缓存命中率 > 70%

---

### 任务 5.2: 错误处理和日志改进

**优先级**: P2  
**预计时间**: 2天  
**负责人**: 全栈开发

**任务描述**:
- 统一错误处理机制
- 实现结构化日志
- 添加错误追踪
- 实现用户友好的错误消息

**验收标准**:
- [ ] 所有错误都有适当处理
- [ ] 日志结构化且可搜索
- [ ] 用户看到友好的错误消息

---

### 任务 5.3: 文档格式支持扩展

**优先级**: P2  
**预计时间**: 4天  
**负责人**: 后端开发

**任务描述**:
- 支持Word文档（.docx）
- 支持Excel文档（.xlsx）
- 支持纯文本文件（.txt）
- 实现格式检测和路由

**验收标准**:
- [ ] 支持至少3种文档格式
- [ ] 格式检测准确
- [ ] 文本提取质量良好

---

## 📊 进度跟踪

### 里程碑

| 里程碑 | 目标日期 | 状态 | 完成度 |
|--------|---------|------|--------|
| Sprint 1完成 | 第2周末 | 🟡 进行中 | 30% |
| Sprint 2完成 | 第4周末 | ⏳ 待开始 | 0% |
| Sprint 3完成 | 第6周末 | ⏳ 待开始 | 0% |
| Sprint 4完成 | 第8周末 | ⏳ 待开始 | 0% |
| Phase 1 MVP | 第8周末 | ⏳ 待开始 | 0% |

### 每周进度检查点

- **周一**: 周会，回顾上周进度，计划本周任务
- **周三**: 中期检查，解决阻塞问题
- **周五**: 周总结，更新进度，准备下周计划

---

## ✅ 验收标准

### Phase 1 MVP验收标准

根据PRD要求，Phase 1需要达到以下标准：

1. **功能完整性**
   - [ ] 能够上传和处理PDF文档
   - [ ] 能够基于文档进行智能问答（RAG）
   - [ ] 能够生成基于文档内容的报告
   - [ ] 报告包含数据可视化

2. **性能指标**
   - [ ] 查询响应时间 < 3秒（P95）
   - [ ] 文档处理速度 > 100 PDFs/小时
   - [ ] API可用性 > 99.5%
   - [ ] 支持并发用户 > 50

3. **质量指标**
   - [ ] 回答准确率 ≥ 75%（基于SME评估）
   - [ ] 回答忠实度 ≥ 90%（基于引用）
   - [ ] 上下文召回率 ≥ 85%
   - [ ] 测试覆盖率 ≥ 70%

4. **用户体验**
   - [ ] 用户满意度 > 4.0/5.0
   - [ ] 每个回答都有源引用
   - [ ] 报告质量达到专业标准
   - [ ] UI/UX流畅易用

---

## 🚨 风险和缓解措施

### 风险1: 向量数据库性能问题

**风险描述**: ChromaDB可能无法满足生产环境性能要求

**影响**: 高  
**概率**: 中

**缓解措施**:
- 提前进行性能测试
- 准备备选方案（Qdrant或Azure AI Search）
- 实现缓存机制

---

### 风险2: Embedding生成速度慢

**风险描述**: sentence-transformers本地运行可能较慢

**影响**: 中  
**概率**: 中

**缓解措施**:
- 实现批量处理和异步处理
- 考虑使用API服务（如果预算允许）
- 优化模型选择（使用更快的模型）

---

### 风险3: RAG回答质量不达标

**风险描述**: 即使实现了RAG，回答质量可能仍不理想

**影响**: 高  
**概率**: 中

**缓解措施**:
- 持续优化提示词
- 实现A/B测试
- 收集用户反馈并迭代
- 考虑使用更强的LLM模型

---

### 风险4: 测试重建时间超预期

**风险描述**: 重建测试套件可能比预期耗时更长

**影响**: 中  
**概率**: 高

**缓解措施**:
- 优先测试关键功能
- 使用测试生成工具
- 逐步增加测试覆盖

---

## 📝 开发规范

### 代码规范

- **Python**: 遵循PEP 8，使用Black格式化
- **TypeScript**: 遵循ESLint规则
- **提交信息**: 使用约定式提交（Conventional Commits）

### Git工作流

- **主分支**: `main` - 生产就绪代码
- **开发分支**: `develop` - 开发集成
- **功能分支**: `feature/xxx` - 新功能开发
- **修复分支**: `fix/xxx` - Bug修复

### 代码审查

- 所有代码必须经过至少一人审查
- 关键功能需要至少两人审查
- 使用Pull Request进行代码审查

---

## 📚 参考资料

### 技术文档

- [ChromaDB文档](https://docs.trychroma.com/)
- [sentence-transformers文档](https://www.sbert.net/)
- [FastAPI文档](https://fastapi.tiangolo.com/)
- [React文档](https://react.dev/)

### 项目文档

- [项目现状文档](项目现状文档.md)
- [产品需求文档 (PRD)](Product%20Requirements%20Document%20(PRD).md)
- [项目简介](ed-research-tool-brief.md)

---

## 📞 联系和支持

### 开发团队

- **后端负责人**: [待指定]
- **前端负责人**: [待指定]
- **AI工程师**: [待指定]
- **项目经理**: [待指定]

### 沟通渠道

- **日常沟通**: Slack/Teams
- **周会**: 每周一上午
- **问题追踪**: GitHub Issues
- **文档**: 项目Wiki

---

## 📅 更新日志

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|---------|--------|
| 2025-11-18 | 1.1 | 更新Sprint 1进度：向量数据库集成已完成 | AI Assistant |
| 2025-11-18 | 1.0 | 初始版本，基于项目现状文档生成 | AI Assistant |

---

**文档维护**: 本文档应每周更新，反映实际进度和调整  
**下次审查**: 每周五  
**最后更新**: 2025年11月18日（v1.1 - 更新Sprint 1进度）

