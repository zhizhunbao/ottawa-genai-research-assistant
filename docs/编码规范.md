# 📋 编码规范 | Coding Standards

## 🚫 **严格禁止的代码模式**

### ❌ **禁止 TODO/FIXME 标记**

**核心规则**: 代码中**严格禁止**包含任何 TODO、FIXME、HACK、XXX 等未完成标记。

所有提交的代码必须是**完整可用的实现**，不允许包含任何占位符或待办事项。

```python
# ❌ 严格禁止 - 包含 TODO 标记
def get_document(doc_id: str):
    # TODO: 实现真实的文档获取逻辑
    pass

# ❌ 严格禁止 - 包含 FIXME 标记  
async def process_data():
    # FIXME: 需要添加适当的错误处理
    return mock_data

# ❌ 严格禁止 - 返回模拟数据
def get_user_info(user_id: str):
    return {"id": "mock", "name": "测试用户"}

# ✅ 正确示例 - 完整实现
def get_document(doc_id: str) -> DocumentInfo:
    """从仓库获取文档信息。"""
    doc_service = DocumentService()
    document = doc_service.get_by_id(doc_id)
    if not document:
        raise HTTPException(status_code=404, detail="文档未找到")
    return DocumentInfo.from_document(document)

# ✅ 正确示例 - 完整的异步实现
async def process_data(data: ProcessRequest) -> ProcessResponse:
    """处理数据请求并返回结果。"""
    try:
        validator = DataValidator()
        validated_data = await validator.validate(data)
        
        processor = DataProcessor()
        result = await processor.process(validated_data)
        
        return ProcessResponse(
            success=True,
            data=result,
            message="数据处理成功"
        )
    except ValidationError as e:
        raise HTTPException(status_code=400, detail=f"数据验证失败: {e}")
    except ProcessingError as e:
        raise HTTPException(status_code=500, detail=f"数据处理失败: {e}")
```

### 🎯 **完整实现原则**

#### 1. **函数实现完整性**
- 每个函数必须有完整的业务逻辑实现
- 所有参数必须被正确使用和验证
- 返回值必须符合类型注解和业务需求

#### 2. **API 端点完整性**
- 每个 API 端点必须连接到真实的服务层
- 必须包含适当的错误处理和状态码
- 必须有完整的请求/响应模型定义

#### 3. **数据模型完整性**
- 所有模型字段必须有明确的类型和验证规则
- 必须包含适当的序列化/反序列化逻辑
- 必须有完整的文档说明

#### 4. **异常处理完整性**
- 每个可能的异常情况都必须有具体的处理逻辑
- 错误信息必须对用户友好且信息充分
- 必须记录适当的日志信息

### 📝 **代码质量强制要求**

#### ✅ **必须包含的元素**
- **完整的类型注解**: 所有函数参数和返回值
- **详细的文档字符串**: 中文描述功能、参数、返回值
- **错误处理和验证**: 覆盖所有可能的异常情况
- **单元测试覆盖**: 每个函数至少有基础测试用例
- **日志记录**: 关键操作必须有适当的日志

#### ❌ **严禁包含的元素**
- **TODO/FIXME/HACK 标记**: 任何形式的待办标记
- **空函数体**: 除了抽象接口定义外
- **Mock 数据返回**: 生产代码中不允许返回假数据
- **硬编码临时值**: 魔法数字或临时字符串
- **未处理的异常**: 不能有 `pass` 或空的异常处理

### 🔍 **代码审查检查清单**

#### 🚨 **自动拒绝条件 (一票否决)**
- [ ] 包含 TODO、FIXME、HACK、XXX 等标记
- [ ] 函数返回 Mock 或假数据
- [ ] 空函数实现 (pass 语句)
- [ ] 缺少基本的错误处理
- [ ] 缺少类型注解
- [ ] 缺少文档字符串

#### ✅ **通过审查的条件**
- [ ] 所有函数都有完整实现
- [ ] 所有 API 连接到真实服务
- [ ] 完整的类型注解和文档
- [ ] 适当的错误处理和验证
- [ ] 基础单元测试覆盖
- [ ] 符合项目的命名规范

#### 🎯 **优秀代码的标准**
- [ ] 代码逻辑清晰易懂
- [ ] 性能考虑合理
- [ ] 安全性措施到位
- [ ] 可维护性良好
- [ ] 测试覆盖率高

## 🛠️ **实施和检查工具**

### 📋 **Pre-commit Hook 自动检查**
```bash
#!/bin/bash
# .git/hooks/pre-commit

echo "🔍 检查代码规范..."

# 检查 TODO 标记
if grep -r "TODO\|FIXME\|HACK\|XXX" --include="*.py" .; then
    echo "❌ 发现 TODO/FIXME 标记，请完成实现后再提交"
    exit 1
fi

# 检查空函数实现
if grep -r "def.*:\s*pass" --include="*.py" .; then
    echo "❌ 发现空函数实现，请完成功能后再提交"
    exit 1
fi

# 检查 Mock 数据返回
if grep -r "return.*mock\|return.*Mock" --include="*.py" .; then
    echo "❌ 发现 Mock 数据返回，请实现真实逻辑"
    exit 1
fi

echo "✅ 代码规范检查通过"
```

### 🔧 **IDE 配置建议**

#### VS Code 配置 (settings.json)
```json
{
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.typing.analysis.typeCheckingMode": "strict",
    "todohighlight.keywords": [
        {
            "text": "TODO",
            "color": "#ff0000",
            "backgroundColor": "#ffcccc",
            "diagnosticSeverity": "error"
        },
        {
            "text": "FIXME",
            "color": "#ff0000", 
            "backgroundColor": "#ffcccc",
            "diagnosticSeverity": "error"
        }
    ]
}
```

#### PyCharm 配置
- 设置 TODO 高亮为错误级别
- 启用严格类型检查
- 配置代码模板避免生成 TODO

### 📊 **质量度量指标**

#### 🎯 **项目质量目标**
- **代码覆盖率**: ≥ 80%
- **类型注解覆盖率**: 100%
- **文档字符串覆盖率**: 100%
- **TODO 标记数量**: 0 (零容忍)
- **代码重复率**: ≤ 5%

#### 📈 **持续改进**
- 每周进行代码质量报告
- 定期重构遗留代码
- 团队代码审查培训
- 最佳实践分享会议

## 🎓 **开发最佳实践**

### 💡 **编写高质量代码的技巧**

1. **先写测试，再写实现** (TDD)
2. **小步提交，频繁集成**
3. **代码自解释，减少注释依赖**
4. **优先考虑代码可读性**
5. **及时重构，避免技术债务**

### 🚀 **性能和安全考虑**

- **数据库查询优化**: 避免 N+1 查询
- **缓存策略**: 合理使用 Redis 缓存
- **输入验证**: 所有用户输入必须验证
- **SQL 注入防护**: 使用参数化查询
- **敏感数据保护**: 不在日志中记录密码等

## 📚 **相关文档链接**

- [系统架构指南](./系统架构指南.md)
- [API 设计规范](./API_DESIGN_GUIDE.md)  
- [测试规范文档](./TESTING_STANDARDS.md)
- [部署检查清单](./部署说明.md)
- [数据管理指南](./数据管理指南.md)

## ⚠️ **重要声明**

**本规范为强制性标准，所有开发人员必须严格遵守。**

**违反以下规则的代码将被自动拒绝合并:**
- 包含任何 TODO/FIXME 标记
- 返回 Mock 或假数据  
- 空函数实现
- 缺少基本错误处理

**请在提交代码前进行充分的自测和代码审查，确保符合所有规范要求。**

---

*最后更新: 2024年12月*  
*维护团队: Ottawa GenAI 开发组* 